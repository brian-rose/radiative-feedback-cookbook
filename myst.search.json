{"version":"1","records":[{"hierarchy":{"lvl1":"Radiative Feedback Cookbook"},"type":"lvl1","url":"/","position":0},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook"},"content":"\n\n\n\n\n\n\n\n\n\nThis Project Pythia Cookbook explores the fundamental science and practice of radiative feedback analysis applied to climate model output.","type":"content","url":"/","position":1},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Motivation"},"type":"lvl2","url":"/#motivation","position":2},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Motivation"},"content":"There are several well-established methods for quantifying radiative feedbacks from climate model output, and these have been widely used in the scientific literature. However, a comprehensive set of tutorials representing best practices for implementing these methods has been lacking, forcing new practioners to “reinvent the wheel” and piece together the implementation details from sometimes incomplete descriptions in the primary literature.\n\nThis Cookbook aims to fill this gap by collecting a verbose set of tutorials that take the reader through some of the basic theory and implementation details, with plentiful example code that can be easily adapted to new datasets and new research applications. The examples will skew heavily toward the method of radiative kernels, with some comparison to other methods.","type":"content","url":"/#motivation","position":3},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Authors"},"type":"lvl2","url":"/#authors","position":4},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Authors"},"content":"Brian Rose, \n\nRachel Tam, \n\nTy Janoski, \n\nRobert Ford, \n\nHannah Zafar, \n\nAna Castaneda Montoya, and \n\nKathryn Rooney","type":"content","url":"/#authors","position":5},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Contributors","lvl2":"Authors"},"type":"lvl3","url":"/#contributors","position":6},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Contributors","lvl2":"Authors"},"content":"","type":"content","url":"/#contributors","position":7},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Structure"},"type":"lvl2","url":"/#structure","position":8},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Structure"},"content":"This Cookbook is organized as follows:","type":"content","url":"/#structure","position":9},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Foundations","lvl2":"Structure"},"type":"lvl3","url":"/#foundations","position":10},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Foundations","lvl2":"Structure"},"content":"This section takes the reader through some of the basic ideas and provides an overview of the mathematical theory underlying the radiative kernel method.","type":"content","url":"/#foundations","position":11},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Feedback Analysis","lvl2":"Structure"},"type":"lvl3","url":"/#feedback-analysis","position":12},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Feedback Analysis","lvl2":"Structure"},"content":"This section links the theory to the practice by demonstrating the detailed implementation of some radiative feedback calculations.","type":"content","url":"/#feedback-analysis","position":13},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Simplifying Calculations","lvl2":"Structure"},"type":"lvl3","url":"/#simplifying-calculations","position":14},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Simplifying Calculations","lvl2":"Structure"},"content":"This section gives more practical example code for carrying out feedback calculations on CMIP6 data, making use of some specialized software packages.","type":"content","url":"/#simplifying-calculations","position":15},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Running the Notebooks"},"type":"lvl2","url":"/#running-the-notebooks","position":16},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl2":"Running the Notebooks"},"content":"You can either run the notebook using \n\nBinder or on your local machine.","type":"content","url":"/#running-the-notebooks","position":17},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Running on Binder","lvl2":"Running the Notebooks"},"type":"lvl3","url":"/#running-on-binder","position":18},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Running on Binder","lvl2":"Running the Notebooks"},"content":"The simplest way to interact with a Jupyter Notebook is through\n\n\nBinder, which enables the execution of a\n\n\nJupyter Book in the cloud. The details of how this works are not\nimportant for now. All you need to know is how to launch a Pythia\nCookbooks chapter via Binder. Simply navigate your mouse to\nthe top right corner of the book chapter you are viewing and click\non the rocket ship icon, (see figure below), and be sure to select\n“launch Binder”. After a moment you should be presented with a\nnotebook that you can interact with. I.e. you’ll be able to execute\nand even change the example programs. You’ll see that the code cells\nhave no output at first, until you execute them by pressing\nShift+Enter. Complete details on how to interact with\na live Jupyter notebook are described in \n\nGetting Started with\nJupyter.","type":"content","url":"/#running-on-binder","position":19},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Running on Your Own Machine","lvl2":"Running the Notebooks"},"type":"lvl3","url":"/#running-on-your-own-machine","position":20},{"hierarchy":{"lvl1":"Radiative Feedback Cookbook","lvl3":"Running on Your Own Machine","lvl2":"Running the Notebooks"},"content":"If you are interested in running this material locally on your computer, you will need to follow this workflow:\n\nClone the https://github.com/ProjectPythia/radiative-feedback-cookbook repository: git clone https://github.com/ProjectPythia/radiative-feedback-cookbook.git\n\nMove into the radiative-feedback-cookbook directorycd radiative-feedback-cookbook\n\nCreate and activate your conda environment from the environment.yml fileconda env create -f environment.yml\nconda activate feedback-cookbook-dev\n\nMove into the notebooks directory and start up Jupyterlabcd notebooks/\njupyter lab","type":"content","url":"/#running-on-your-own-machine","position":21},{"hierarchy":{"lvl1":"Feedbacks with ClimKern"},"type":"lvl1","url":"/notebooks/foundations/climkern-calc","position":0},{"hierarchy":{"lvl1":"Feedbacks with ClimKern"},"content":"\n\n\n\n","type":"content","url":"/notebooks/foundations/climkern-calc","position":1},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Overview"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#overview","position":2},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Overview"},"content":"While it is good to know how to manually calculate radiative feedbacks, it is also time-consuming to constantly recreate the code. Here, we will use a Python package called ClimKern \n\nJanoski et al., 2025 that offers functions to calculate radiative feedbacks from climate model or reanalysis output. The advantages of using ClimKern go beyond making it simpler—it standardizes the methods and assumptions that go into these sometimes complicated calculations. We will use CMIP6 output in this notebook. You will learn how to:\n\nDownload CMIP6 data from Pangeo’s space on Google Cloud.\n\nObtain a radiative kernel from the ClimKern repository.\n\nCalculate the surface albedo, temperature, and water vapor feedbacks.\n\nCompute the cloud feedbacks using the two main methods: residual and adjustment.\n\nQuantify stratospheric feedbacks.\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#overview","position":3},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Prerequisites"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#prerequisites","position":4},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nIntro to Xarray\n\nNecessary\n\n\n\nIntro to Cartopy\n\nNecessary\n\n\n\nIntro to Matplotlib\n\nHelpful\n\n\n\nLoading CMIP6 Data with Intake-ESM\n\nHelpful\n\n\n\nTime to learn: 20 minutes\n\n\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#prerequisites","position":5},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Imports"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#imports","position":6},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Imports"},"content":"\n\nimport climkern as ck\nimport intake\nimport matplotlib.pyplot as plt\nimport s3fs\nimport fsspec\nimport xarray as xr\nimport glob\nimport importlib.util\nimport os\nimport cartopy.crs as ccrs\n\n%matplotlib inline\nplt.rcParams[\"figure.dpi\"] = 100\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#imports","position":7},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Download the kernel"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#download-the-kernel","position":8},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Download the kernel"},"content":"\n\nNormally, when ClimKern is installed, the user needs to download data on the command\nline from the Zenodo repository. However, we now have the data on Jetstream2, so\nwe can download it from there and save it in our package repository.\n\nNote\n\nFuture versions of ClimKern will be able to pull the kernel from Jetstream2 without storing locally.\n\nFirst, set the URL and path to point to ClimKern. Also, specify which kernel you want.\n\nURL = \"https://js2.jetstream-cloud.org:8001/\" # URL for jetstream access\npath = f\"pythia/ClimKern\" # Location of ClimKern\nkernel = \"ERA5\"\n\nNext, read in the data from Jetstream2\n\n# Read in data\n# Set up access to jetstream2\nfs = fsspec.filesystem(\"s3\", anon=True, client_kwargs=dict(endpoint_url=URL))\npattern = f\"s3://{path}/kernels/\"+kernel+f\"/TOA*.nc\"\n\n# Grab the data\nfiles = sorted(fs.glob(pattern))\nfs.invalidate_cache() # This is necessary to deal with peculiarities of objects served from jetstream2\n\n# Open file and make it Xarray Dataset\nkern = xr.open_dataset(fs.open(files[0]))\n\n# Save path for later\npath_out = files[0].split(kernel+\"/\",1)[1]\n\nTo save this data in ClimKern’s directory, we have to figure out where it is on the\nmachine. After that, we will go ahead and save out the kernel as a netCDF in\nClimKern’s local data directory.\n\n# Get the package location\nspec = importlib.util.find_spec(\"climkern\")\npackage_dir = os.path.dirname(spec.origin)\n\n# print(f\"The package directory is: {package_dir}\")\n\n# Define the path where you want to save the netCDF file within the package directory\nnetcdf_path = os.path.join(package_dir,\"data/kernels\",kernel,path_out)\n\n# Ensure the directory exists\nos.makedirs(os.path.dirname(netcdf_path), exist_ok=True)\n\n# Save the dataset as a netCDF file\nkern.to_netcdf(netcdf_path)\n\nNow, let’s just make sure we can retrieve the kernel.\n\nck.util.get_kern(kernel)\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#download-the-kernel","position":9},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Prepare the CMIP6 Data"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#prepare-the-cmip6-data","position":10},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Prepare the CMIP6 Data"},"content":"\n\nTo start, we will need some CMIP6 data to calculate feedbacks. We will use the\npreindustrial control and 4×CO_2 experiments from just one model (CESM2).\n\n# Make a list of variables and experiments we need\nvar_list = [\"rsds\",\"rsus\",\"ta\",\"ts\",\"ps\",\"hus\"]\nexp_list = [\"piControl\",\"abrupt-4xCO2\"]\n\n# Specify data location, open it\ncat_url = \"https://storage.googleapis.com/cmip6/pangeo-cmip6.json\"\ncol = intake.open_esm_datastore(cat_url)\n\n# Create a catalog of matching simulations\ncat = col.search(experiment_id=exp_list,source_id=\"CESM2\",variable_id=var_list,\n                table_id=\"Amon\")\n\n# Convert to a dictionary of Xarray Datasets\nds_dict = cat.to_dataset_dict(zarr_kwargs={'consolidated': True})\n\nThe data, especially the preindustrial control simulation that will serve as our\ncontrol climate, is huge. We are going to only use the last 50 years of the control\nand last 30 years of the abrupt 4×CO_2 simulation. There are a few extra coordinates\nand/or dimensions we don’t need, hence the squeeze().\n\n# Our control simulation\nctrl = ds_dict[\"CMIP.NCAR.CESM2.piControl.Amon.gn\"].isel(\n    time=slice(-600,None)).squeeze().compute()\n\n# The increase CO2 aka \"perturbed\" simulation\npert = ds_dict[\"CMIP.NCAR.CESM2.abrupt-4xCO2.Amon.gn\"].isel(\n    time=slice(-360,None)).squeeze().compute()\n\nTo save a little diskspace because ClimKern still isn’t dask compatible yet,\nlet’s make our control climatology ahead of time.\n\nctrl = ctrl.groupby(ctrl.time.dt.month).mean(dim=\"time\").rename({\"month\":\"time\"})\npert = pert.groupby(pert.time.dt.month).mean(dim=\"time\").rename({\"month\":\"time\"})\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#prepare-the-cmip6-data","position":11},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Feedback calculations"},"type":"lvl2","url":"/notebooks/foundations/climkern-calc#feedback-calculations","position":12},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl2":"Feedback calculations"},"content":"\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#feedback-calculations","position":13},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Calculate surface temperature change","lvl2":"Feedback calculations"},"type":"lvl3","url":"/notebooks/foundations/climkern-calc#calculate-surface-temperature-change","position":14},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Calculate surface temperature change","lvl2":"Feedback calculations"},"content":"\n\nClimKern outputs feedbacks as radiative perturbations at the TOA (because there are multiple ways to quantify feedbacks). One of the most common ways is to normalize by the change in the surface temperature, which puts values in “true” feedback units of W/m^2/K. For that, we start by calculating the change in the surface temperature in our CESM2 experiment.\n\n# Take difference between pert and ctrl ts fields\nΔts = pert.ts - ctrl.ts\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#calculate-surface-temperature-change","position":15},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Surface albedo feedback","lvl2":"Feedback calculations"},"type":"lvl3","url":"/notebooks/foundations/climkern-calc#surface-albedo-feedback","position":16},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Surface albedo feedback","lvl2":"Feedback calculations"},"content":"\n\nPerhaps the simplest of the radiative feedbacks to calculate is the surface albedo\nfeedback because it requires only two variables and is a 3-dimensional field (no height\ncoordinate). The variables we will use are as follows:\n\nVariable name\n\nDescription\n\nUnits\n\nrsus\n\nThe upwelling shortwave radiation at the surface\n\nW/m^2\n\nrsds\n\nThe downwelling shortwave radiation at the surface\n\nW/m^2\n\nThe \n\ncalc_alb_feedback() function is straightforward. Be sure to include our kernel name\nin the arguments.\n\nalb = ck.calc_alb_feedback(\n    ctrl.rsus,ctrl.rsds,pert.rsus,pert.rsds,kern=\"ERA5\"\n)\n\nLet’s see what the resulting Dataarray looks like.\n\nalb\n\nThis function allows for the quick creation of a pre-configured map, eliminating the need to repeat setup code by setting up the figure, axes, and Cartopy Robinson projection.\n\ndef base_map():\n    proj= ccrs.Robinson()  #select Robinson projection\n\n    fig, ax = plt.subplots(subplot_kw=dict(projection=proj)) #Create the figure and axis \n \n    ax.coastlines() # Add coastlines\n\n    return fig, ax\n\n\n\nSimilar to the function above, these dictionaries encapsulate the repetitive code setup and provide a set of reusable arguments to simplify the plotting of data onto this map.\n\nplotargs = {'transform': ccrs.PlateCarree(),\n            'cbar_kwargs': {\"orientation\": \"horizontal\", \"shrink\": 0.7, \n                            \"label\":\"W/m$^2$\"}\n            }\n\nplotargs_2 = {'transform': ccrs.PlateCarree(),\n            'cbar_kwargs': {\"orientation\": \"horizontal\", \"shrink\": 0.7,\n                           \"label\":\"W/m$^2$/K\"}\n            }\n\nFinally, let’s plot the time average surface albedo feedback on a map, first as just the perturbation.\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the surface albedo feedback \nalb.mean(dim=\"time\").plot(ax=ax, **plotargs)\n\n# Add a title\nax.set_title(\"Time-averaged Surface Albedo Feedback\");\n\nNow normalized by the surface temperature change...\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot surface albedo feedback & add coastlines\n(alb.mean(dim=\"time\")/Δts.mean(dim=\"time\")).plot(ax=ax, **plotargs_2)\n\n# Add a title\nax.set_title(\"Time-averaged Surface Albedo Feedback\");\n\nAs one might expect, the greatest radiative change at the TOA from the surface albedo feedback is near the poles where there is melting sea ice and snow.\n\nLet’s end by calculating the global average. ClimKern comes with a \n\nspat_avg() function.\n\n# Output the time-averaged global surface albedo feedback\noutput = \"The global average surface albedo feedback is {value:.2f} W/m\\u00b2/K.\"\nprint(output.format(value=float(ck.spat_avg((alb.mean(dim=\"time\")/Δts.mean(dim=\"time\")\n                                         ).expand_dims(\"time\")))))\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#surface-albedo-feedback","position":17},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Planck and lapse rate feedbacks","lvl2":"Feedback calculations"},"type":"lvl3","url":"/notebooks/foundations/climkern-calc#planck-and-lapse-rate-feedbacks","position":18},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Planck and lapse rate feedbacks","lvl2":"Feedback calculations"},"content":"\n\nAs a reminder, the total tropospheric temperature feedback is often decomposed into a distict Planck and lapse rate feedback. ClimKern has a single function that produces both feedbacks simultaneously called \n\ncalc_T_feedbacks(). The variables we need this time are:\n\nVariable name\n\nDescription\n\nUnits\n\nNotes\n\nta\n\nThe 4-dimensional air temperature\n\nK\n\n\n\nts\n\nThe 3-dimensional surface skin temperature\n\nK\n\n\n\nps\n\nThe 3-dimensional surface pressure\n\nPa, mb, or hPa\n\n\n\ntrop_p\n\nThe 3-dimensional tropopause height\n\nPa, mb, or hPa\n\nOptional\n\nCMIP6 output rarely contains the tropopause height, so we will create a default tropopause that decreases linearly with the cosine of latitude from 100 hPa at the Equator to 300 hPa at the poles.\n\n# Use ClimKern's \"hidden\" make_tropo function\npert[\"trop_p\"] = ck.util.make_tropo(pert.ps)\npert.trop_p.attrs[\"units\"] = \"Pa\"\n\nlr,pl = ck.calc_T_feedbacks(\n    ctrl.ta,ctrl.ts,ctrl.ps,pert.ta,pert.ts,pert.ps,pert_trop=pert.trop_p,kern=\"ERA5\"\n)\n\nSimple. Let’s see what it looks like.\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the surface albedo feedback \nlr.mean(dim=\"time\").plot(ax=ax, **plotargs)\n\n# Add a title\nax.set_title(\"Time-averaged Lapse Rate Feedback\");\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot surface albedo feedback\n(lr.mean(dim=\"time\")/Δts.mean(dim=\"time\")).plot(ax=ax, **plotargs_2)\n\n# Add a title\nax.set_title(\"Time-averaged Lapse Rate Feedback\");\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot surface albedo feedback\npl.mean(dim=\"time\").plot(ax=ax, cmap=\"Blues_r\", **plotargs)\n\n# Add a title\nax.set_title(\"Time-averaged Planck Feedback\");\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot surface albedo feedback\n(pl.mean(dim=\"time\")/Δts.mean(dim=\"time\")).plot(ax=ax,cmap=\"Blues_r\", **plotargs_2)\n\n# Add a title\nax.set_title(\"Time-averaged Planck Feedback\");\n\nThese results seem reasonable. The Planck feedback is often the feedback with the largest magnitude and scales nonlinearly with temperature change. The lapse rate feedback changes sign depending on the vertical structure of the atmosphere is usually positive (warming) at the poles and negative (cooling) in the tropics.\n\nLet’s get those global averages again!\n\n# Output the time-averaged global temperature feedbacks\noutput = (\"The global average lapse rate and Planck feedbacks are\"+\n          \" {lr:.2f} and {pl:.2f} W/m\\u00b2/K, respectively.\")\nprint(output.format(lr=float(ck.spat_avg((lr.mean(dim=\"time\")/Δts.mean(dim=\"time\")\n                                         ).expand_dims(\"time\"))),\n                   pl=float(ck.spat_avg((pl.mean(dim=\"time\")/Δts.mean(dim=\"time\")\n                                        ).expand_dims(\"time\")))))\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#planck-and-lapse-rate-feedbacks","position":19},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Water vapor feedbacks","lvl2":"Feedback calculations"},"type":"lvl3","url":"/notebooks/foundations/climkern-calc#water-vapor-feedbacks","position":20},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Water vapor feedbacks","lvl2":"Feedback calculations"},"content":"\n\nHere we use ClimKern to calculate the longwave and shortwave water vapor feedabcks. ClimKern has a single function that produces both called \n\ncalc_q_feedbacks(). This function requires both the specific humidity and air temperature because ClimKern has to normalize the water vapor kernels to make them compatible with the specific humidity.\n\nVariable name\n\nDescription\n\nUnits\n\nNotes\n\nhus\n\nThe 4-dimensional specific humidity\n\n\\frac{g}{g} or \\frac{g}{kg}\n\n\n\nta\n\nThe 4-dimensional air temperature\n\nK\n\n\n\nps\n\nThe 3-dimensional surface pressure\n\nPa, mb, or hPa\n\n\n\ntrop_p\n\nThe 3-dimensional tropopause height\n\nPa, mb, or hPa\n\nOptional\n\nThere is one more argument we can provide called method, which is simply a number 1-4. This corresponds to whether to use a fractional approximation for logarithms, use the logarithms explicitly, or use the linear change in water vapor concentration. See the discussion in Section 3.2 of \n\nJanoski et al. (2025), and see \n\nhere in the climkern docs for how these are implemented.\n\nWe will use method=1 which is to use the natural logarithm of specific humidity without doing a fractional approximation.\n\nWe will use the same tropopause height as before.\n\n# Use ClimKern's water vapor feedback function\nqlw,qsw = ck.calc_q_feedbacks(\n    ctrl.hus,ctrl.ta,ctrl.ps,pert.hus,pert.ps,pert_trop=pert.trop_p,kern=\"ERA5\",\n    method=1\n)\n\nLet’s take a look, starting with the longwave.\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the longwave water vapor feedback\nqlw.mean(dim=\"time\").plot(ax=ax,cmap=\"Reds\", **plotargs)\n\n# Add a title\nax.set_title(\"Time-averaged LW Water Vapor Feedback\");\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the longwave water vapor feedback \n(qlw.mean(dim=\"time\")/Δts.mean(dim=\"time\")).plot(ax=ax,cmap=\"Reds\", **plotargs_2)\nax.coastlines()\n\n# Add a title\nax.set_title(\"Time-averaged LW Water Vapor Feedback\");\n\nAnd now the shortwave...\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the longwave water vapor feedback and add coastlines\nqsw.mean(dim=\"time\").plot(ax=ax,cmap=\"Reds\", **plotargs)\n\n\n# Add a title\nax.set_title(\"Time-averaged SW Water Vapor Feedback\");\n\n# Create the base map\nfig, ax = base_map()\n\n# Plot the longwave water vapor feedback and add coastlines\n(qsw.mean(dim=\"time\")/Δts.mean(dim=\"time\")).plot(ax=ax,cmap=\"Reds\", **plotargs_2)\n\n# Add a title\nax.set_title(\"Time-averaged SW Water Vapor Feedback\");\n\n# Output the time-averaged global surface albedo feedback\noutput = (\"The global average longwave and shortwave water vapor feedbacks are\"+\n          \" {lw:.2f} and {sw:.2f} W/m\\u00b2/K, respectively.\")\nprint(output.format(lw=float(ck.spat_avg((qlw.mean(dim=\"time\")/Δts.mean(dim=\"time\")\n                                         ).expand_dims(\"time\"))),\n                   sw=float(ck.spat_avg((qsw.mean(dim=\"time\")/Δts.mean(dim=\"time\")\n                                        ).expand_dims(\"time\")))))\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#water-vapor-feedbacks","position":21},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Cloud feedbacks","lvl2":"Feedback calculations"},"type":"lvl3","url":"/notebooks/foundations/climkern-calc#cloud-feedbacks","position":22},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl3":"Cloud feedbacks","lvl2":"Feedback calculations"},"content":"\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#cloud-feedbacks","position":23},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl4":"Download radiative forcing","lvl3":"Cloud feedbacks","lvl2":"Feedback calculations"},"type":"lvl4","url":"/notebooks/foundations/climkern-calc#download-radiative-forcing","position":24},{"hierarchy":{"lvl1":"Feedbacks with ClimKern","lvl4":"Download radiative forcing","lvl3":"Cloud feedbacks","lvl2":"Feedback calculations"},"content":"\n\nIt’s time for cloud feedbacks. However, like anything to do with clouds, there are some complications. You ideally need the effective radiative forcing (ERF), which is a measure of radiative imbalance imposed by CO_2 in the absence of surface temperature change \n\nSmith et al., 2020. Thankfully, CESM2 radiative forcing for our scenarios is available on the Google cloud.\n\n# Specify data location, open it\ncat_url = \"https://storage.googleapis.com/cmip6/pangeo-cmip6.json\"\ncol = intake.open_esm_datastore(cat_url)\n\n# # Create a catalog of matching simulations\ncat = col.search(activity_id=\"RFMIP\",source_id=\"CESM2\",experiment_id=[\"piClim-4xCO2\",\n                                                                      \"piClim-control\"],\n                variable_id=[\"rlut\",\"rsut\",\"rsdt\"])\n\n# Convert to a dictionary of Xarray Datasets\nds_dict = cat.to_dataset_dict(zarr_kwargs={'consolidated': True})\n\n# Assign Datasets to variables\nrf_ctrl = ds_dict[\"RFMIP.NCAR.CESM2.piClim-control.Amon.gn\"]\nrf_pert = ds_dict[\"RFMIP.NCAR.CESM2.piClim-4xCO2.Amon.gn\"]\n\nInfoYour relevant information here!\n\nFeel free to copy this around and edit or play around with yourself. Some other admonitions you can put in:\n\nSuccessWe got this done after all!\n\nWarningBe careful!\n\nDangerScary stuff be here.\n\nWe also suggest checking out Jupyter Book’s \n\nbrief demonstration on adding cell tags to your cells in Jupyter Notebook, Lab, or manually. Using these cell tags can allow you to \n\ncustomize how your code content is displayed and even \n\ndemonstrate errors without altogether crashing our loyal army of machines!\n\n","type":"content","url":"/notebooks/foundations/climkern-calc#download-radiative-forcing","position":25},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks"},"type":"lvl1","url":"/notebooks/foundations/energy-balance-model","position":0},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks"},"content":"\n\n\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model","position":1},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Overview"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#overview","position":2},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Overview"},"content":"This tutorial focuses on introducing the fundamental concepts of the energy balance model and radiative feedback, and establish notations and definitions for the rest of the cookbook.\n\nThe following topics will be covered in this tutorial:\n\nThe Energy Balance Model\n\nWhat is Radative Feedback\n\nMethods to Calculate Radiative Feedback\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#overview","position":3},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Prerequisites"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#prerequisites","position":4},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nTBD\n\nNecessary\n\n\n\nTime to learn: >30 minutes\n\n\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#prerequisites","position":5},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Radiative Budget Analysis"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#radiative-budget-analysis","position":6},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Radiative Budget Analysis"},"content":"\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#radiative-budget-analysis","position":7},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"The Energy Balance Model"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#the-energy-balance-model","position":8},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"The Energy Balance Model"},"content":"\n\nNote\n\nFor a more comprehensive material about the energy balance model, pokearounds on the energy balance model, and introductions to simpler energy balance models like the two-box model, feel free to check out other resources like the \n\nClimate Laboratory and Chapter 2 - Global Energy Balance of the book by \n\nHartmann (2016).\n\nImagine a scenario where we start off with an energy-balanced Earth, where at top of atmosphere (TOA) flux towards Earth’s surface is equal to the TOA flux going out to space.\n\nNow if we double the concentration levels of carbon dioxide (CO_2) in the atmopshere - the surface temperature is going to increase through the greenhouse-effect instantaneously. However, climate processes can amplify or dampen the climate response. For example, the surface may radiate more out to space due to the surface warming, which would dampen the overall warming. On the other hand, there may be more water vapor to absorb the outgoing longwave radiation in the atmosphere due to the increased rate of evaporation from the warming, and thus amplifies the warming.\n\nTo put this into equations, let R be the radiative imbalance, S_0 as the solar insolation, \\alpha as the planetary albedo, and together, S_0/4 (1-\\alpha) represents the absorbed solar radiation. OLR is the outgoing longwave radiation. At equilibrium where the incoming flux equals to the outgoing flux, R = 0.R = F_{in} - F_{out}R = S_0/4 (1-\\alpha) - OLR\n\nIn this case, the addition of CO_{2} induces a change in the radiative flux at the top of the atmosphere, and is quantified as the raditive forcing F. The climate responds to the radiative imbalance by changing the global mean temperature. We can relate the global mean surface temperature to the external perturbation and the radiative imbalance at TOA by the following equation:R = F + \\lambda T\n\nwhere R is the net TOA flux anomaly (positive downward), F is the effective radiative forcing, \\lambda is the feedback parameter, also known as the climate response parameter, and T is the global mean surface temperature anomaly, relative to the temperature at equilibrium.\n\nOther typical conventions of the same values used within the community:\n\nR = N (e.g., \n\nGregory et al. (2004));\n\nR = H (e.g., \n\nDessler & Zelinka (2015));\n\nF = \\Delta Q  (e.g., \n\nBony et al. (2006));\n\n\\lambda = \\alpha (e.g., \n\nGregory et al. (2004));\n\nNote\n\nAs you explore the feedback-forcing space, you may stumble upon the term climate sensitivity, which is the relationship between the magnitude of the climate change response and the doubling-CO_2 forcing with the unit in Kelvin.ECS = \\frac{1}{\\lambda}\n\nThis metric tells how much the climate system would warm per unit of radiative forcing (typically doubling of CO_{2}). Ch.10 Climate Sensitivity and Feedback Mechanisms of the book by \n\nHartmann (2016) and the chapter Climate Feedbacks in the Encyclopedia of Atmospheric Sciences \n\nDessler & Zelinka, 2015 provide a holistic overview on the topic, and \n\nSherwood et al. (2020) would provide the most up-to-date understanding on equilibrium climate sensitivity (ECS) within the community.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#the-energy-balance-model","position":9},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#radiative-feedback-lambda","position":10},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Radiative Feedback (\\lambda)"},"content":"","type":"content","url":"/notebooks/foundations/energy-balance-model#radiative-feedback-lambda","position":11},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"So, what is a feedback and why does it matter?","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#so-what-is-a-feedback-and-why-does-it-matter","position":12},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"So, what is a feedback and why does it matter?","lvl2":"Radiative Feedback (\\lambda)"},"content":"Feedback is the climate system response to an external radiative forcing \n\nHansen et al., 1984, \n\nBony et al., 2006. When the global mean surface temperature changes, climate variables may change as well. These climate variable changes would influence the Earth’s radiation balance and contribute to the radiative response.\n\nNote that feedback is different from the radiative response, where the former has the unit of W m^{-2} K^{-1} and is quantified by the feedback parameter \\lambda, while the latter  has the unit of W m^{-2}, quantified by \\lambda T.\n\nLet x be a vector representing an ensemble of climate variables like atmospheric temperature, water vapor, surface ice and snow. The formal definition of the system’s total feedback parameter, which is the strength of the climate system’s net feedback, is as follow \n\n:\\lambda = \\frac{\\partial R}{\\partial T_{s}} = \\sum^{x} \\frac{\\partial R}{\\partial x} \\frac{\\partial x}{\\partial T_{s}} + \\sum \\sum \\frac{\\partial ^{2}R}{\\partial x \\partial y} \\frac{\\partial x \\partial y}{\\partial T_{s}^{2}} + ...\n\n(UNDER CONSTRUCTION: source needed for why do this+populate explanation on equation - Dessler and Zelinka 2015 explains it more intuitively, but require conversion from g to \\lambda)\n\nThe net feedback parameter is reduced to the first order \n\nSherwood et al., 2020:\\lambda = \\sum^{x}_{i}\\lambda_{i} = \\sum^{x} \\frac{\\partial R}{\\partial x} \\frac{\\partial x}{\\partial T_{s}}\n\nA positive feedback (\\lambda > 0) would make the forced response bigger while a negative feedback (\\lambda < 0) stabilizes the forced response. In the following subsections, we will discuss each feedback mechanism in detail and how the mechanism would feed back into enhancing or muting the response.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#so-what-is-a-feedback-and-why-does-it-matter","position":13},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"Types of Feedbacks","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#types-of-feedbacks","position":14},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"Types of Feedbacks","lvl2":"Radiative Feedback (\\lambda)"},"content":"Feedbacks below are listed following \n\nSherwood et al., 2020 and are limited to feedbacks that directly affect the top-of-the-atmosphere (TOA) radiation budget, and respond to surface temperature mostly through physical processes \n\nBony et al., 2006:\n\nPlanck Feedback\n\nSurface Albedo Feedback\n\nWater Vapor Feedback\n\nLapse Rate Feedback\n\nCloud Feedback\n\nThe list above is not exhaustive. Feedbacks like the carbon cycle feedback are not included due to the carbon dioxide level being prescribed for the experimental set-up in \n\nSherwood et al. (2020). Other feedbacks like the atmospheric ozone feedback and stratospheric feedback are not included as they are not normally quantified \n\nSherwood et al., 2020.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#types-of-feedbacks","position":15},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"1. Planck “Feedback” (Negative under warming)","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#id-1-planck-feedback-negative-under-warming","position":16},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"1. Planck “Feedback” (Negative under warming)","lvl2":"Radiative Feedback (\\lambda)"},"content":"Planck feedback is the extra longwave (LW) emission to space from a vertically uniform warming of the surface and atmosphere, while holding all climate variable unchanged.\n\nThe Planck feedback can be explained by the Stefan-Boltzmann law, which states that the total energy radiated per unit surface area per unit time is directly proportional to the fourth power of the black body’s temperature.F = \\sigma T^4\n\nwhere \\sigma is the Stefan-Boltzmann constant (5.67 \\times 10^{-8} W m^{-2} K^{-4}). If everything else is held constant, we can calculate the rate of change of TOA flux due to the change in surface warming by taking the derivative of the Stefan-Boltzmann law. Taking the Earth’s average outgoing longwave radiation as 240 W m^{−2} (e.g., \n\nLoeb et al. (2018)) for the global effective emission temperature T_{e} as 255 K, and substitute it as follow:-4\\sigma T_e^3 \\approx - 3.76~\\text{W}~\\text{m}^{-2}~\\text{K}^{-1}\n\nIf we include the planetary emissivity \\epsilon, we will get \\lambda_{Planck} \\approx -3.3 W m^{-2} K^{-1}, which is close to observations \n\nDessler, 2013 and global climate models \n\nCaldwell et al., 2016).\n\nSimply put, the more you heat, the more LW radiation go out.\n\n[TO BE POLISHED]\nKernel related: structural uncertainty in Planck feedback arises from differences in spatial pattern of surface warming and climatological distribution fo clodus and water vapor that determines planetary emissivity - affects radiative temperature kernel \n\nSherwood et al., 2020.\n\nTypes of radiative kernels there are: sfc albedo, air temp (vert.varying) , surf temp, LW water vapor kernel, SW water vapor kernel\n\nNote\n\nPlanck feedback not necessarily accurately represented in climate models due to lack of stratospheric warming \n\nCronin & Dutta, 2023.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#id-1-planck-feedback-negative-under-warming","position":17},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"2. Surface Albedo Feedback (Positive under warming)","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#id-2-surface-albedo-feedback-positive-under-warming","position":18},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"2. Surface Albedo Feedback (Positive under warming)","lvl2":"Radiative Feedback (\\lambda)"},"content":"\n\nThe surface albedo feedback, also known as the ice-albedo feedback, pertains primarily to the high latitudes, where snow and ice are present. Snow and ice have very high albedo (reflectivity). Snow has the highest albedo (up to 90%), while sea ice albedo ranges from 50-70%. Melt ponds further reduce the albedo, and as ice recedes, open ocean can be as low as 6%.\n\nThis process consitutes a positive feedback loop: melt of snow and ice decreases albedo, causing additional radiation absorption. More absorption causes temperatures to rise, which further contributes to melt, restarting the cycle.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#id-2-surface-albedo-feedback-positive-under-warming","position":19},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"3. Water Vapor Feedback: (Positive under warming)","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#id-3-water-vapor-feedback-positive-under-warming","position":20},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"3. Water Vapor Feedback: (Positive under warming)","lvl2":"Radiative Feedback (\\lambda)"},"content":"[UNDER CONSTRUCTION]\n\nWater vapor feedback and lapse rate feedback are commonly discussed together as they are both dependent on the how much water vapor is present in the atmosphere.\n\nWater vapor feedback is defined as the change in TOA net flux due to the increase in water vapor per degree of surface warming.\n\nWater vapor interacts with both longwave and shortwave radiation.  captures the change in outgoing LW and absorbed SW radiation at TOA due to the changes in the atmospheric water vapor concentration.\n\n[insert pic of capacity of jar increases as temperature increase]\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#id-3-water-vapor-feedback-positive-under-warming","position":21},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"4. Lapse Rate Feedback (Negative under warming)","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#id-4-lapse-rate-feedback-negative-under-warming","position":22},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"4. Lapse Rate Feedback (Negative under warming)","lvl2":"Radiative Feedback (\\lambda)"},"content":"\n\nLATERRRRRR\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#id-4-lapse-rate-feedback-negative-under-warming","position":23},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"5. Cloud Feedback","lvl2":"Radiative Feedback (\\lambda)"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#id-5-cloud-feedback","position":24},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"5. Cloud Feedback","lvl2":"Radiative Feedback (\\lambda)"},"content":"\n\nThe cloud feedback mechanism is the most complex feedback discussed in this tutorial. There are several reasons for this. Clouds interact with both shortwave (SW) solar radiation and longwave (LW) terrestrial radiation and exert varying radiative effects depending on their properties (cloud type, height, optical depth, liquid and ice water content, particule sizes, etc).\n\nGenerally, high-level clouds do not interact much with solar radiation but easily absorb terrestrial radiation, preventing its loss to space and contribute to warming. Low-level clouds reflect solar radiation during the day, which contributes to cooling, but absorb some terrestrial radiation,  contributing to warming (particularly at night!). Thus, high-level clouds tend to exert a positive climate feedback, while low-level clouds tend to exert an overall negative climate feedback.\n\n\n\n\nCredit: Paulo Ceppi\n\nCloud feedbacks produced by climate models tend to vary greatly, which is largely attributed to the issue of scale in modern GCMs (ESMs??). GCMs are at resolutions much too large to resolve the microscopic processes dictating the formation and properties of clouds.\nCloud formation and lifetime is additionally complex as it is highly dependent on atmospheric aerosol loading, which is another complex discussion. Of course, clouds are also intrinsically tied to atmospheric water vapor content.\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#id-5-cloud-feedback","position":25},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Methods to Calculate Raditaive Feedback"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#methods-to-calculate-raditaive-feedback","position":26},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Methods to Calculate Raditaive Feedback"},"content":"\n\nTypically radiative feedback are calculated with global climate models. :O\n\nPRP method\n\nWorkin on it >:)\n\nSuccessWe got this done after all!\n\nWarningBe careful!\n\nDangerScary stuff be here.\n\nWe also suggest checking out Jupyter Book’s \n\nbrief demonstration on adding cell tags to your cells in Jupyter Notebook, Lab, or manually. Using these cell tags can allow you to \n\ncustomize how your code content is displayed and even \n\ndemonstrate errors without altogether crashing our loyal army of machines!\n\n\n\n","type":"content","url":"/notebooks/foundations/energy-balance-model#methods-to-calculate-raditaive-feedback","position":27},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Summary"},"type":"lvl2","url":"/notebooks/foundations/energy-balance-model#summary","position":28},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl2":"Summary"},"content":"Add one final --- marking the end of your body of content, and then conclude with a brief single paragraph summarizing at a high level the key pieces that were learned and how they tied to your objectives. Look to reiterate what the most important takeaways were.","type":"content","url":"/notebooks/foundations/energy-balance-model#summary","position":29},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"What’s next?","lvl2":"Summary"},"type":"lvl3","url":"/notebooks/foundations/energy-balance-model#whats-next","position":30},{"hierarchy":{"lvl1":"Energy Balance Model and Feedbacks","lvl3":"What’s next?","lvl2":"Summary"},"content":"Let Jupyter book tie this to the next (sequential) piece of content that people could move on to down below and in the sidebar. However, if this page uniquely enables your reader to tackle other nonsequential concepts throughout this book, or even external content, link to it here!\n\nReferences:\n\nBony et al. 2006\n\nZelinka et al. 2020\n\nSherwood et al. 2020\n\nDessler and Zelinka 2015 (Encyclopedia of Atmospheric Sciences)\n\nHartmann 2016 (Global Physical Climatology)\n\nHansen et al. 1984\n\nGregory et al. 2004\n\nMore to come","type":"content","url":"/notebooks/foundations/energy-balance-model#whats-next","position":31},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels"},"type":"lvl1","url":"/notebooks/foundations/manual-calc","position":0},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels"},"content":"\n\n\n\n","type":"content","url":"/notebooks/foundations/manual-calc","position":1},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Overview"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#overview","position":2},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Overview"},"content":"This notebook details the steps required to perform a radiative kernel analysis.\n\n","type":"content","url":"/notebooks/foundations/manual-calc#overview","position":3},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Prerequisites"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#prerequisites","position":4},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Prerequisites"},"content":"Concepts\n\nImportance\n\nNotes\n\nLoading CMIP6 data with Intake-ESM\n\nHelpful\n\n\n\nIntro to Xarray\n\nNecessary\n\n\n\nTime to learn: 60 minutes\n\n\n\n","type":"content","url":"/notebooks/foundations/manual-calc#prerequisites","position":5},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Imports"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#imports","position":6},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Imports"},"content":"\n\nimport xarray as xr\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom matplotlib.colors import CenteredNorm\nimport cartopy.crs as ccrs\nimport xesmf as xe\nimport intake\nimport s3fs\nimport fsspec\nimport glob\n\n","type":"content","url":"/notebooks/foundations/manual-calc#imports","position":7},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Loading in required data"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#loading-in-required-data","position":8},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Loading in required data"},"content":"\n\n","type":"content","url":"/notebooks/foundations/manual-calc#loading-in-required-data","position":9},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Climate model output","lvl2":"Loading in required data"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#climate-model-output","position":10},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Climate model output","lvl2":"Loading in required data"},"content":"In this example, we will perform the analysis on a single model from the CMIP6 ensemble, CESM2. The simplest way to calculate feedbacks is to take differences between two climate states, as opposed to regressions. Here we use runs with:\n\npreindustrial conditions (piControl) as the control climate\n\ninstantaneously quadrupled CO_2 (abrupt-4xCO2) as the perturbed climate\n\nWe will use CMIP6 data hosted on Pangeo’s Google Cloud Storage:\n\ncat_url = 'https://storage.googleapis.com/cmip6/pangeo-cmip6.json'\ncol = intake.open_esm_datastore(cat_url)\n\nThe fields (and CMIP names) required to calculate each feedback are:\n\nAlbedo: upwelling and downwelling SW radiation at the surface (rsus and rsds)\n\nTemperature (Planck and lapse rate): air temperature (ta) and surface temperature (ts)\n\nWater vapor: specific humidity (hus) and air temperature\n\nSW CRE: Net SW radiation at TOA (down rsdt minus up rsut) and clear-sky versions (down, which is the same, minus up rsutcs)\n\nLW CRE: Net LW radiation at TOA (rlut) and the clear-sky version (rlutcs)\n\nThe cloud feedbacks require the results from the other feedbacks to correct for noncloud contributions to the CREs.\n\nWe will also need near-surface air temperature (tas) for calculating the change in global mean surface temperature (GMST).\n\ncat = col.search(activity_id='CMIP', experiment_id=['piControl', 'abrupt-4xCO2'], table_id='Amon', source_id='CESM2', \n                 variable_id=['rsus', 'rsds', 'ta', 'ts', 'hus', 'rsdt', 'rsut', 'rsutcs', 'rlut', 'rlutcs', 'tas'])\ncat.df\n\ndset_dict = cat.to_dataset_dict(zarr_kwargs={'consolidated': True})\n\nctrl = dset_dict['CMIP.NCAR.CESM2.piControl.Amon.gn']\n\nctrl\n\npert = dset_dict['CMIP.NCAR.CESM2.abrupt-4xCO2.Amon.gn']\n\npert\n\n","type":"content","url":"/notebooks/foundations/manual-calc#climate-model-output","position":11},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Radiative forcing data","lvl2":"Loading in required data"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#radiative-forcing-data","position":12},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Radiative forcing data","lvl2":"Loading in required data"},"content":"To calculate the cloud feedback, we will need the effective radiative forcing (ERF) resulting from 4xCO2, which we can find under another project, RFMIP:\n\nrf_cat = col.search(activity_id='RFMIP', experiment_id='piClim-4xCO2', source_id='CESM2')\nrf_cat.df\n\nrf_dset_dict = rf_cat.to_dataset_dict(zarr_kwargs={'consolidated': True})\n\nforcing = rf_dset_dict['RFMIP.NCAR.CESM2.piClim-4xCO2.Amon.gn']\nforcing\n\n","type":"content","url":"/notebooks/foundations/manual-calc#radiative-forcing-data","position":13},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Radiative kernels","lvl2":"Loading in required data"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#radiative-kernels","position":14},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Radiative kernels","lvl2":"Loading in required data"},"content":"We will load in radiative kernels from Project Pythia’s storage on JetStream2. We will be using the ERA5 kernels \n\n(Huang & Huang 2023).\n\nURL = 'https://js2.jetstream-cloud.org:8001/'\npath = f'pythia/ClimKern'\nfs = fsspec.filesystem(\"s3\", anon=True, client_kwargs=dict(endpoint_url=URL))\npatternKern = f's3://{path}/kernels/ERA5/*.nc'\npatternTutorial = f's3://{path}/tutorial_data/*.nc'\nfilesKern = sorted(fs.glob(patternKern))\nfilesTutorial = sorted(fs.glob(patternTutorial))\nfs.invalidate_cache() # This is necessary to deal with peculiarities of objects served from jetstream2\nfilesetKern = [fs.open(file) for file in filesKern[0:2]]\nfilesetTutorial = [fs.open(file) for file in filesKern[0:2]]\n\nWe will use the more common TOA kernels.\n\nfilesKern\n\nAs we will see in a moment, the naming convention for months as calculated from Xarray’s .groupby() method (“month”, 1-12) is different from what is used in the kernel dataset (“time”, 0-11), so we need to align them:\n\ndata_kern = xr.open_dataset(filesetKern[1])\ndata_kern['time'] = data_kern['time'] + 1\ndata_kern = data_kern.rename({'time': 'month'})\ndata_kern\n\nLet’s take a look at some of these kernels. First, the albedo kernel, annually averaged:\n\ndata_kern.sw_a.mean(dim='month').plot.contourf(levels=20)\n\nAnd the LW water vapor kernel, annually and zonally averaged:\n\ndata_kern.lw_q.mean(dim=['month', 'lon']).plot.contourf(levels=40, yincrease=False)\n\n","type":"content","url":"/notebooks/foundations/manual-calc#radiative-kernels","position":15},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Preparing data for analysis"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#preparing-data-for-analysis","position":16},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Preparing data for analysis"},"content":"\n\nDefine a function for taking global averages:\n\ndef global_average(data):\n    weights = np.cos(np.deg2rad(data.lat))\n    data_weighted = data.weighted(weights)\n    return data_weighted.mean(dim=['lat', 'lon'], skipna=True)\n\nTo get a general idea of how the climate changes in these runs, we can plot the 12-month rolling GMST for the two runs:\n\ngmst_ctrl = global_average(ctrl.tas.rolling(time=12, center=True).mean())\n\ngmst_ctrl.sel(time=slice('1150', '1200')).plot()\n\ngmst_pert = global_average(pert.tas.rolling(time=12, center=True).mean())\n\ngmst_pert.sel(time=slice('0949', '0999')).plot()\n\n","type":"content","url":"/notebooks/foundations/manual-calc#preparing-data-for-analysis","position":17},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Calculating the two climate states","lvl2":"Preparing data for analysis"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#calculating-the-two-climate-states","position":18},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Calculating the two climate states","lvl2":"Preparing data for analysis"},"content":"Ideally, we would want to compare two equilibrated climates, but since that is usually not possible with standard-length CMIP experiments, we will simply use the monthly climatology over the last 50 years available for each run, which is close enough to equilibrium. The pressure coordinates are in Pa, so let’s convert them to hPa to match the kernels:\n\nctrl_state = ctrl.sel(time=slice('1150', '1200')).groupby('time.month').mean(dim='time').squeeze()\npert_state = pert.sel(time=slice('0949', '0999')).groupby('time.month').mean(dim='time').squeeze()\n\nctrl_state['plev'] = ctrl_state['plev']/100\npert_state['plev'] = pert_state['plev']/100\n\npert_state\n\nWe will need the change in GMST in order to calculate the feedbacks:\n\ndgmst = global_average(pert_state.tas - ctrl_state.tas).mean(dim='month')\ndgmst.load()\n\n","type":"content","url":"/notebooks/foundations/manual-calc#calculating-the-two-climate-states","position":19},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Regridding","lvl2":"Preparing data for analysis"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#regridding","position":20},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Regridding","lvl2":"Preparing data for analysis"},"content":"The model output and kernels are not on the same grid, so we will regrid the kernel dataset to the model’s grid using the regridding package xesmf. For reusability, let’s define a function to regrid data:\n\ndef regrid(ds_in, regrid_to, method='bilinear'):\n    regridder = xe.Regridder(ds_in, regrid_to, method=method, periodic=True, ignore_degenerate=True)\n    ds_out = regridder(ds_in)\n    return ds_out\n\nregr_kernels = regrid(data_kern, pert_state)\n\nregr_kernels\n\nCheck that the kernels look as expected:\n\nregr_kernels.sw_a.mean(dim='month').plot.contourf(levels=20)\n\nregr_kernels.lw_q.mean(dim=['month', 'lon']).plot.contourf(levels=40, yincrease=False)\n\nctrl_state = ctrl_state.interp_like(regr_kernels, kwargs={\"fill_value\": \"extrapolate\"})\npert_state = pert_state.interp_like(regr_kernels, kwargs={\"fill_value\": \"extrapolate\"})\n\n","type":"content","url":"/notebooks/foundations/manual-calc#regridding","position":21},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Calculating feedbacks"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#calculating-feedbacks","position":22},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Calculating feedbacks"},"content":"For all noncloud feedbacks, we will calculate both the all-sky and clear-sky (indicated by clr in the kernel dataset here) change in TOA radiation \\Delta R. For the clear-sky calculations, we just use the clear-sky version of the kernel in place of the all-sky kernel. The differences \\Delta R^\\mathrm{clear}_X-\\Delta R^\\mathrm{all}_X for each feedback X will be used later to adjust the CREs into proper cloud feedbacks.\n\nFor the feedbacks involving fields that are a function of pressure (i.e., temperature and water vapor), we need to mask out the stratosphere. In this notebook, we will approximate this using a function that masks above 100 hPa at the equator and linearly decreases to 300 hPa at the poles:\n\ndef tropo_mask(ds):\n    return ds.where(ds.plev > ((200/90)*abs(ds.lat) + 100))\n\nCompare:\n\nctrl_state.ta.mean(dim=['month', 'lon']).plot(yincrease=False)\n\ntropo_mask(ctrl_state.ta.mean(dim=['month', 'lon'])).plot(yincrease=False)\n\n","type":"content","url":"/notebooks/foundations/manual-calc#calculating-feedbacks","position":23},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Surface albedo","lvl2":"Calculating feedbacks"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#surface-albedo","position":24},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Surface albedo","lvl2":"Calculating feedbacks"},"content":"\n\nThe first step is to calculate the change in albedo between the control and perturbed climates. The surface albedo \\alpha is defined as the fraction of downwelling solar radiation at the surface that is reflected back up. That is,\\alpha=\\frac{S^\\uparrow_\\mathrm{s}}{S^\\downarrow_\\mathrm{s}}=\\frac{\\mathtt{rsus}}{\\mathtt{rsds}}\n\nalb_ctrl = (ctrl_state.rsus/ctrl_state.rsds.where(ctrl_state.rsds > 0)).fillna(0)\nalb_pert = (pert_state.rsus/pert_state.rsds.where(ctrl_state.rsds > 0)).fillna(0)\n\nNote that we avoided dividing by zero by masking regions where rsds = 0 and filling in the resulting nans with 0. Now, take the difference:\n\ndalb = alb_pert - alb_ctrl\n\ndalb.mean(dim='month').plot()\n\nBy multiplying the change in albedo with the albedo kernel, we get the change in TOA radiation (in units W m^{-2}) resulting from that change in albedo:\\Delta R_\\alpha=K_\\alpha\\cdot\\Delta\\alpha\n\nWe also need to multiply by 100 to get albedo as a percentage.\n\ndSW_alb = regr_kernels.sw_a * dalb * 100\ndSW_alb = dSW_alb.where(dSW_alb != float('-inf'), np.nan)\ndSW_alb_clr = regr_kernels.swclr_a * dalb * 100\ndSW_alb_clr = dSW_alb_clr.where(dSW_alb != float('-inf'), np.nan)\n\ndSW_alb.mean(dim='month').plot()\n\nThe feedback in units W m^{-2} K^{-1} is then calculated by normalizing this change in TOA radiation by the change in GMST:\\lambda_\\alpha=\\frac{\\Delta R_\\alpha}{\\Delta T_\\mathrm{s}}\n\nalb_feedback = dSW_alb/dgmst\n\nalb_feedback.mean(dim='month').plot()\n\nTaking the global and annual average, we get a final value of:\n\nglobal_average(alb_feedback.mean(dim='month')).load()\n\n","type":"content","url":"/notebooks/foundations/manual-calc#surface-albedo","position":25},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#temperature","position":26},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"content":"The temperature feedback is decomposed into Planck and lapse rate feedbacks, but first, we can calculate the change in TOA LW radiation resulting from changes in surface (ts) and air (ta) temperature. The first step is calculating the changes in surface and air temperature. At the same time, we will interpolate ta to the kernel pressure levels:\n\ndts = pert_state.ts - ctrl_state.ts\ndta = pert_state.ta - ctrl_state.ta\n\nApproximate layer thickness:\n\ndp = -dta.plev.diff(dim='plev', label='lower')\ndp\n\nThen the change in TOA radiation using the kernels:\\Delta R_{T_\\mathrm{s}}=K_{T_\\mathrm{s}}\\cdot\\Delta T_\\mathrm{s}\n\nAnd for feedbacks that involve functions of pressure, we integrate (sum) over the pressure levels. These kernels have units W m^{-2} K^{-1} (100 hPa)^{-1}, so if \\Delta p is in hPa,\\Delta R_T=\\sum_p K_T\\cdot\\Delta T\\cdot\\Delta p/100\n\ndLW_ts = regr_kernels.lw_ts * dts\ndLW_ts_clr = regr_kernels.lwclr_ts * dts\n\ndLW_ta = (regr_kernels.lw_t * tropo_mask(dta) * dp/100).sum(dim='plev', skipna=True)\ndLW_ta_clr = (regr_kernels.lwclr_t * tropo_mask(dta) * dp/100).sum(dim='plev', skipna=True)\n\ndLW_ts.mean(dim='month').plot()\n\ndLW_ta.mean(dim='month').plot()\n\nThe full temperature feedback is the sum of these, normalized by the change in GMST:\\lambda_T=\\frac{\\Delta R_{T_\\mathrm{s}}+\\Delta R_T}{\\Delta T_\\mathrm{s}}\n\nt_feedback = (dLW_ta + dLW_ts)/dgmst\n\nt_feedback.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$ K$^{-1}$'})\n\nFor the annual and global average, we get in W m^{-2} K^{-1}:\n\ngm_t_feedback = global_average(t_feedback.mean(dim='month')).load()\ngm_t_feedback\n\n","type":"content","url":"/notebooks/foundations/manual-calc#temperature","position":27},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Planck","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#planck","position":28},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Planck","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"content":"There are two components to the Planck feedback:\n\nThe change in TOA radiation due to the surface warming (calculated in the previous section)\n\nThe change in TOA radiation due to a vertically-uniform warming\n\nWe assume a vertically-uniform warming based on the surface temperature. To do this, project the surface warming into the vertical. One way to do this with Xarray is:\n\ndts_3d = dts.expand_dims(dim={'plev': dta.plev})\n\nCheck the vertical profile:\n\ndts_3d.mean(dim=['month', 'lon']).plot(yincrease=False)\n\ndLW_dts_3d = (regr_kernels.lw_t * tropo_mask(dts_3d) * dp/100).sum(dim='plev', skipna=True)\n\nThe sum of the two components divided by the change in GMST is the Planck feedback:\n\nplanck_feedback = (dLW_ts + dLW_dts_3d)/dgmst\n\nplanck_feedback.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$ K$^{-1}$'})\n\nAnnual and global average:\n\ngm_planck_feedback = global_average(planck_feedback.mean(dim='month')).load()\ngm_planck_feedback\n\n","type":"content","url":"/notebooks/foundations/manual-calc#planck","position":29},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Lapse rate","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#lapse-rate","position":30},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Lapse rate","lvl3":"Temperature","lvl2":"Calculating feedbacks"},"content":"\n\nThe lapse rate feedback is calculated using the vertically-nonuniform warming. To do this, we subtract the surface temperature change that we projected into the vertical from the air temperature change, also masking out the stratosphere:\n\ndt_lapserate = tropo_mask(dta - dts_3d)\n\ndt_lapserate\n\nMultiply by the LW temperature kernel and integrate over pressure:\n\ndLW_lapserate = (regr_kernels.lw_t * tropo_mask(dt_lapserate) * dp/100).sum(dim='plev', skipna=True)\n\nDivide by change in GMST to get the feedback:\n\nlapserate_feedback = dLW_lapserate/dgmst\n\nlapserate_feedback.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$ K$^{-1}$'})\n\nGlobal average:\n\ngm_lapserate_feedback = global_average(lapserate_feedback.mean(dim='month')).load()\ngm_lapserate_feedback\n\nThe sum of the Planck and lapse rate feedbacks should equal the full temperature feedback we calculated first:\\lambda_{\\mathrm{Planck}}+\\lambda_{\\mathrm{LR}}\\approx\\lambda_T\n\n(gm_planck_feedback + gm_lapserate_feedback).values, gm_t_feedback.values\n\n","type":"content","url":"/notebooks/foundations/manual-calc#lapse-rate","position":31},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#water-vapor","position":32},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"content":"\n\nWhen calculating the water vapor feedbacks, it is common to use the log difference \\Delta\\ln q=\\ln q_{\\mathrm{pert}}-\\ln q_{\\mathrm{ctrl}} instead of the linear difference \\Delta q=q_{\\mathrm{pert}}-q_{\\mathrm{ctrl}}. We also need to normalize the kernels by the log change in specific humidity per unit warming, \\partial\\ln q/\\partial T. First, we will define a function to calculate the saturation specific humidity (Buck 1981). Note that we want temperature in deg C and pressure in hPa for these formulas to work.\n\ndef qs(t, p=None):\n    t = t - 273.15\n    # Get pressure in hPa\n    p = t.plev/100\n    \n    # Saturation vapor pressure (liquid and ice)\n    esl = (1.0007 + 3.46e-6 * p) * 6.1121 * np.exp((17.502 * t) / (240.97 + t))\n    esi = (1.0003 + 4.18e-6 * p) * 6.1115 * np.exp((22.452 * t) / (272.55 + t))\n\n    # Convert from vapor pressure to mixing ratio\n    wsl = 0.622*esl/(p - esl)\n    wsi = 0.622*esi/(p - esi)\n\n    # Use liquid water when temp is above freezing\n    ws = xr.where(t > 0, wsl, wsi)\n\n    # Convert to specific humidity\n    qs = ws/(1 + ws)\n\n    return qs\n\nWe can use the q and T from the control and perturbed climates to approximate the normalization factor:\n\nqs_ctrl = qs(ctrl_state.ta.squeeze())\nqs_pert = qs(pert_state.ta.squeeze())\n\ndlnqdT = (np.log(qs_pert) - np.log(qs_ctrl))/(pert_state.ta.squeeze() - ctrl_state.ta.squeeze())\n\ndlnqdT\n\n","type":"content","url":"/notebooks/foundations/manual-calc#water-vapor","position":33},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Shortwave water vapor","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#shortwave-water-vapor","position":34},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Shortwave water vapor","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"content":"\n\ndlnq = np.log(pert_state.hus) - np.log(ctrl_state.hus)\n\ndSW_q = (regr_kernels.sw_q/dlnqdT * dlnq * dp/100).sum(dim='plev')\n\ndSW_q.mean(dim='month').plot()\n\nswq_feedback = dSW_q/dgmst\n\nswq_feedback.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$ K$^{-1}$'})\n\ngm_swq_feedback = global_average(swq_feedback.mean(dim='month')).load()\ngm_swq_feedback\n\n","type":"content","url":"/notebooks/foundations/manual-calc#shortwave-water-vapor","position":35},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Longwave water vapor","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#longwave-water-vapor","position":36},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Longwave water vapor","lvl3":"Water vapor","lvl2":"Calculating feedbacks"},"content":"\n\ndLW_q = (regr_kernels.lw_q/dlnqdT * dlnq * dp/100).sum(dim='plev')\nlwq_feedback = dLW_q/dgmst\n\nlwq_feedback.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$ K$^{-1}$'})\n\ngm_lwq_feedback = global_average(lwq_feedback.mean(dim='month')).load()\ngm_lwq_feedback\n\n","type":"content","url":"/notebooks/foundations/manual-calc#longwave-water-vapor","position":37},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#cloud","position":38},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"content":"\n\nWe will use the Soden et al. (2008) adjustment method to estimate the cloud feedbacks.\n\n","type":"content","url":"/notebooks/foundations/manual-calc#cloud","position":39},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Cloud radiative effect","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#cloud-radiative-effect","position":40},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Cloud radiative effect","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"content":"\n\nThe cloud radiative effect (CRE) is the change in TOA radiation due to the existence of clouds, so it is the difference between all-sky and clear-sky net TOA radiation. We will use the convention that a positive CRE indicates a warming effect of clouds, and a negative CRE indicates a cooling effect of clouds. We therefore need to take note of the sign convention being used for the radiation. Here are the SW TOA radiation variables:\n\nctrl_state.rsut.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\nPositive values for rsut indicate a positive-up convention. For SW we want to compute:\\mathrm{SWCRE}=\\mathrm{Net}_{\\mathrm{all}}-\\mathrm{Net}_{\\mathrm{clear}}=(\\mathrm{Down}_{\\mathrm{all}}-\\mathrm{Up}_{\\mathrm{all}})-(\\mathrm{Down}_{\\mathrm{clear}}-\\mathrm{Up}_{\\mathrm{clear}})=-\\mathrm{Up}_{\\mathrm{all}}+\\mathrm{Up}_{\\mathrm{clear}}=-\\texttt{rsut}+\\texttt{rsutcs}\n\nwhere the “Down” terms cancel because clouds have no effect on insolation.\n\nctrl_SWCRE = -ctrl_state.rsut + ctrl_state.rsutcs\npert_SWCRE = -pert_state.rsut + pert_state.rsutcs\ndSWCRE = pert_SWCRE - ctrl_SWCRE\n\nCheck the CRE to make sure the sign is correct:\n\nctrl_SWCRE.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\nAs expected, negative values indicate that on the SW side, clouds have a cooling effect. Here is the change in SW CRE:\n\ndSWCRE.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\nThere is reduced (low) cloud cover under the CO2 forcing, so we can interpret this as clouds cooling the planet less under CO2 forcing, implying a positive feedback. Next, the LW version, where we use TOA outgoing longwave radiation:\n\nctrl_state.rlut.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\nPositive-up is also used for rlut, so the calculation is similar:\\mathrm{LWCRE}=\\mathrm{Net}_{\\mathrm{all}}-\\mathrm{Net}_{\\mathrm{clear}}=(\\mathrm{Down}_{\\mathrm{all}}-\\mathrm{Up}_{\\mathrm{all}})-(\\mathrm{Down}_{\\mathrm{clear}}-\\mathrm{Up}_{\\mathrm{clear}})=-\\mathrm{Up}_{\\mathrm{all}}+\\mathrm{Up}_{\\mathrm{clear}}=-\\texttt{rlut}+\\texttt{rlutcs}\n\nwhere the “Down” terms here are just zero.\n\nctrl_LWCRE = -(ctrl_state.rlut - ctrl_state.rlutcs)\npert_LWCRE = -(pert_state.rlut - pert_state.rlutcs)\ndLWCRE = pert_LWCRE - ctrl_LWCRE\n\nctrl_LWCRE.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\nOn the LW side, clouds have a warming effect. Here is the change in LW CRE under the CO2 forcing:\n\ndLWCRE.mean(dim='month').plot(cbar_kwargs={'label': 'W m$^{-2}$'})\n\n","type":"content","url":"/notebooks/foundations/manual-calc#cloud-radiative-effect","position":41},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Adjusting CRE to get cloud feebacks","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"type":"lvl4","url":"/notebooks/foundations/manual-calc#adjusting-cre-to-get-cloud-feebacks","position":42},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl4":"Adjusting CRE to get cloud feebacks","lvl3":"Cloud","lvl2":"Calculating feedbacks"},"content":"\n\nCRE partially masks some non-cloud feedbacks, so CRE needs to be adjusted to account for this.\n\nAttention\n\nThis section is under construction!\n\n","type":"content","url":"/notebooks/foundations/manual-calc#adjusting-cre-to-get-cloud-feebacks","position":43},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Plots","lvl2":"Calculating feedbacks"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#plots","position":44},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"Plots","lvl2":"Calculating feedbacks"},"content":"\n\ndef add_cyclic_point(xarray_obj, dim='lon', period=360):\n    if period is None:\n        period = xarray_obj.sizes[dim] / xarray_obj.coords[dim][:2].diff(dim).item()\n    first_point = xarray_obj.isel({dim: slice(1)})\n    first_point.coords[dim] = first_point.coords[dim]+period\n    return xr.concat([xarray_obj, first_point], dim=dim)\n\nann_planck_feedback = planck_feedback.mean(dim='month').load()\nann_lapserate_feedback = lapserate_feedback.mean(dim='month').load()\nann_lwq_feedback = lwq_feedback.mean(dim='month').load()\nann_swq_feedback = swq_feedback.mean(dim='month').load()\n\npc0 = ccrs.PlateCarree(central_longitude=0)\npc180 = ccrs.PlateCarree(central_longitude=180)\nfig, axs = plt.subplots(2, 2, figsize=(11, 5), dpi=200, subplot_kw=dict(projection=pc180), layout='constrained')\n\nann_planck_feedback.plot.contourf(ax=axs[0, 0], levels=21, cbar_kwargs=dict(label='W m$^{-2}$ K$^{-1}$'), transform=pc0, cmap='Blues_r')\nann_lapserate_feedback.plot(ax=axs[0, 1], levels=21, cbar_kwargs=dict(label='W m$^{-2}$ K$^{-1}$'), transform=pc0)\nann_swq_feedback.plot(ax=axs[1, 0], levels=21, cbar_kwargs=dict(label='W m$^{-2}$ K$^{-1}$'), transform=pc0, cmap='Reds')\nann_lwq_feedback.plot(ax=axs[1, 1], levels=21, cbar_kwargs=dict(label='W m$^{-2}$ K$^{-1}$'), transform=pc0, cmap='Reds')\n\nfor ax in axs.flatten():\n    ax.coastlines()\n\naxs[0, 0].set_title('Planck')\naxs[0, 1].set_title('Lapse rate')\naxs[1, 0].set_title('SW water vapor')\naxs[1, 1].set_title('LW water vapor')\nfig.suptitle('CESM2 radiative feedbacks (4xCO2 $-$ piControl; ERA5 kernels)', y=1.05)\n\nann_dSWCRE = dSWCRE.mean(dim='month').load()\nann_dLWCRE = dLWCRE.mean(dim='month').load()\n\nfig2, axs2 = plt.subplots(1, 2, figsize=(11, 2.5), dpi=200, subplot_kw=dict(projection=pc180), layout='constrained')\n\nann_dSWCRE.plot.contourf(ax=axs2[0], levels=21, cbar_kwargs=dict(label='W m$^{-2}$'), transform=pc0)\nann_dLWCRE.plot(ax=axs2[1], levels=21, cbar_kwargs=dict(label='W m$^{-2}$'), transform=pc0)\n\nfor ax in axs2.flatten():\n    ax.coastlines()\n\naxs2[0].set_title('SW')\naxs2[1].set_title('LW')\nfig2.suptitle('CESM2 $\\\\Delta$CRE (4xCO2 $-$ piControl)', y=1.05)\n\n\n\n","type":"content","url":"/notebooks/foundations/manual-calc#plots","position":45},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Summary"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#summary","position":46},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Summary"},"content":"","type":"content","url":"/notebooks/foundations/manual-calc#summary","position":47},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"What’s next?","lvl2":"Summary"},"type":"lvl3","url":"/notebooks/foundations/manual-calc#whats-next","position":48},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl3":"What’s next?","lvl2":"Summary"},"content":"\n\n","type":"content","url":"/notebooks/foundations/manual-calc#whats-next","position":49},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Resources"},"type":"lvl2","url":"/notebooks/foundations/manual-calc#resources","position":50},{"hierarchy":{"lvl1":"Feedback analysis using radiative kernels","lvl2":"Resources"},"content":"","type":"content","url":"/notebooks/foundations/manual-calc#resources","position":51},{"hierarchy":{"lvl1":"How to Cite This Cookbook"},"type":"lvl1","url":"/notebooks/how-to-cite","position":0},{"hierarchy":{"lvl1":"How to Cite This Cookbook"},"content":"The material in this Project Pythia Cookbook is licensed for free and open consumption and reuse. All code is served under \n\nApache 2.0, while all non-code content is licensed under \n\nCreative Commons BY 4.0 (CC BY 4.0). Effectively, this means you are free to share and adapt this material so long as you give appropriate credit to the Cookbook authors and the Project Pythia community.\n\nThe source code for the book is \n\nreleased on GitHub and archived on Zenodo. This DOI will always resolve to the latest release of the book source:\n\n","type":"content","url":"/notebooks/how-to-cite","position":1}]}