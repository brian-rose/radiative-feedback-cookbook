{"version":2,"kind":"Notebook","sha256":"25d37e6cdb9a6b41155340c2d34e7cf2c48d886ff98b01310b5b4fa365eb257e","slug":"notebooks.foundations.multi-model","location":"/notebooks/foundations/multi-model.ipynb","dependencies":[],"frontmatter":{"title":"Multi-model feedback comparison","authors":[{"id":"brian-rose","nameParsed":{"literal":"Brian E. J. Rose","given":"Brian E. J.","family":"Rose"},"name":"Brian E. J. Rose","orcid":"0000-0002-9961-3821","email":"brose@albany.edu","affiliations":["UAlbany"],"url":"https://brian-rose.github.io","github":"brian-rose","bluesky":"@brianejrose.bsky.social","linkedin":"https://www.linkedin.com/in/brian-rose-37bb55106/"}],"content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/radiative-feedback-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/radiative-feedback-cookbook/blob/main/notebooks/foundations/multi-model.ipynb","exports":[{"format":"ipynb","filename":"multi-model.ipynb","url":"/radiative-feedback-cookbook/build/multi-model-22adb51038a514ba7419dba26841bf05.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EdOTKTYJMG"}],"key":"eZtfbMeZAM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xz2p5rUQMS"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"R5disHQ1ti"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The goal of this notebook is to explore inter-model differences in water vapor and lapse rate feedbacks, as well as the partial cancellation between these differences when the two feedbacks are combined. See discussion in ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"d51Rm6nYEB"},{"type":"citeGroup","kind":"narrative","children":[{"type":"cite","kind":"narrative","label":"Held:2012a","identifier":"held:2012a","children":[{"type":"text","value":"Held & Shell (2012)","key":"BGuxmHTKkE"}],"enumerator":"1","key":"dluQdiGdhc"}],"key":"RcCKRYWJhd"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vKNdn9ghRn"}],"key":"LAhRWv7nPd"},{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"kRROJKqyxq"}],"key":"jbtf8kVgNX"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"This notebook is still under construction and will include more verbose detail at some point in the future!","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ixu0lqaiPi"}],"key":"fedoHpW4uK"}],"key":"PptnakMiKQ"}],"key":"LpdOSYtZEu"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GoJgTItEVd"}],"key":"FKUz856sYs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uICzNXFL4B"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"tcGv8yssiK"}],"key":"rjTgebQ7UB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import climkern as ck\nimport intake\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport s3fs\nimport fsspec\nimport xarray as xr\nimport glob\nimport importlib.util\nimport os\nimport cartopy.crs as ccrs\n\n%matplotlib inline\nplt.rcParams[\"figure.dpi\"] = 100","key":"cjdSSHxsHh"},{"type":"output","id":"PF0aFTZ-GaT6_eIZ6exj2","data":[],"key":"lVidNzsnud"}],"key":"xYfLCv6eDn"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Download the kernel","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GDcEsf60Ze"}],"identifier":"download-the-kernel","label":"Download the kernel","html_id":"download-the-kernel","implicit":true,"key":"GXmft9Xa89"}],"key":"Bje802sjNI"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"bNgAXW5UhN"}],"key":"Apo2BpXIXj"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This follows the same hack as in the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"sHQWorhPY4"},{"type":"link","url":"/notebooks/foundations/climkern-calc","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"ClimKern notebook","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"NA1YAS1eFg"}],"urlSource":"climkern-calc","dataUrl":"/notebooks.foundations.climkern-calc.json","internal":true,"protocol":"file","key":"u2rGhRcYCy"},{"type":"text","value":". Hopefully soon we’ll have a more graceful way to stream the data directly into ClimKern without needing to save to the local workspace.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"CpXIddCGkm"}],"key":"r0mAVeed1w"}],"key":"RIZMDqcxFX"}],"key":"s6HzNXy7vL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"URL = \"https://js2.jetstream-cloud.org:8001/\" # URL for jetstream access\npath = f\"pythia/ClimKern\" # Location of ClimKern\nkernel = \"ERA5\"","key":"Mvg8NRxc81"},{"type":"output","id":"S5Ig9ST9SqKs6I166JWlJ","data":[],"key":"Mugf9gIpl1"}],"key":"el6uGiwaUH"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Next, read in the data from Jetstream2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bihFWMQcG3"}],"key":"qB3HMPzC3a"}],"key":"VKZ0Us8AST"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Read in data\n# Set up access to jetstream2\nfs = fsspec.filesystem(\"s3\", anon=True, client_kwargs=dict(endpoint_url=URL))\npattern = f\"s3://{path}/kernels/\"+kernel+f\"/TOA*.nc\"\n\n# Grab the data\nfiles = sorted(fs.glob(pattern))\nfs.invalidate_cache() # This is necessary to deal with peculiarities of objects served from jetstream2\n\n# Open file and make it Xarray Dataset\nkern = xr.open_dataset(fs.open(files[0]))\n\n# Save path for later\npath_out = files[0].split(kernel+\"/\",1)[1]","key":"b7kvzQyVYb"},{"type":"output","id":"x7gI-BAIGpJ2-Z1qKLA_8","data":[],"key":"vIwbN9pL1a"}],"key":"ykK8u16eQL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"To save this data in ClimKern’s directory, we have to figure out where it is on the\nmachine. After that, we will go ahead and save out the kernel as a netCDF in\nClimKern’s local data directory.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IK6344T332"}],"key":"bwpQSVcLSn"}],"key":"pL7xeroxiq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Get the package location\nspec = importlib.util.find_spec(\"climkern\")\npackage_dir = os.path.dirname(spec.origin)\n\n# print(f\"The package directory is: {package_dir}\")\n\n# Define the path where you want to save the netCDF file within the package directory\nnetcdf_path = os.path.join(package_dir,\"data/kernels\",kernel,path_out)\n\n# Ensure the directory exists\nos.makedirs(os.path.dirname(netcdf_path), exist_ok=True)\n\n# Save the dataset as a netCDF file\nkern.to_netcdf(netcdf_path)","key":"CTEFW6h00O"},{"type":"output","id":"vInyxN-jkiS_SCcixyK7z","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mKeyError\u001b[39m                                  Traceback (most recent call last)\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/file_manager.py:211\u001b[39m, in \u001b[36mCachingFileManager._acquire_with_cache_info\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    210\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m211\u001b[39m     file = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_cache\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_key\u001b[49m\u001b[43m]\u001b[49m\n\u001b[32m    212\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mKeyError\u001b[39;00m:\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/lru_cache.py:56\u001b[39m, in \u001b[36mLRUCache.__getitem__\u001b[39m\u001b[34m(self, key)\u001b[39m\n\u001b[32m     55\u001b[39m \u001b[38;5;28;01mwith\u001b[39;00m \u001b[38;5;28mself\u001b[39m._lock:\n\u001b[32m---> \u001b[39m\u001b[32m56\u001b[39m     value = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_cache\u001b[49m\u001b[43m[\u001b[49m\u001b[43mkey\u001b[49m\u001b[43m]\u001b[49m\n\u001b[32m     57\u001b[39m     \u001b[38;5;28mself\u001b[39m._cache.move_to_end(key)\n\n\u001b[31mKeyError\u001b[39m: [<class 'netCDF4._netCDF4.Dataset'>, ('/home/runner/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/climkern/data/kernels/ERA5/TOA_ERA5_Kerns.nc',), 'a', (('clobber', True), ('diskless', False), ('format', 'NETCDF4'), ('persist', False)), '071da2fc-4178-4aff-b690-c1b5d3e14c60']\n\nDuring handling of the above exception, another exception occurred:\n\n\u001b[31mPermissionError\u001b[39m                           Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[4]\u001b[39m\u001b[32m, line 14\u001b[39m\n\u001b[32m     11\u001b[39m os.makedirs(os.path.dirname(netcdf_path), exist_ok=\u001b[38;5;28;01mTrue\u001b[39;00m)\n\u001b[32m     13\u001b[39m \u001b[38;5;66;03m# Save the dataset as a netCDF file\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m14\u001b[39m \u001b[43mkern\u001b[49m\u001b[43m.\u001b[49m\u001b[43mto_netcdf\u001b[49m\u001b[43m(\u001b[49m\u001b[43mnetcdf_path\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/core/dataset.py:2029\u001b[39m, in \u001b[36mDataset.to_netcdf\u001b[39m\u001b[34m(self, path, mode, format, group, engine, encoding, unlimited_dims, compute, invalid_netcdf, auto_complex)\u001b[39m\n\u001b[32m   2026\u001b[39m     encoding = {}\n\u001b[32m   2027\u001b[39m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mxarray\u001b[39;00m\u001b[34;01m.\u001b[39;00m\u001b[34;01mbackends\u001b[39;00m\u001b[34;01m.\u001b[39;00m\u001b[34;01mapi\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m to_netcdf\n\u001b[32m-> \u001b[39m\u001b[32m2029\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mto_netcdf\u001b[49m\u001b[43m(\u001b[49m\u001b[43m  \u001b[49m\u001b[38;5;66;43;03m# type: ignore[return-value]  # mypy cannot resolve the overloads:(\u001b[39;49;00m\n\u001b[32m   2030\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m   2031\u001b[39m \u001b[43m    \u001b[49m\u001b[43mpath\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2032\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2033\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43mformat\u001b[39;49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mformat\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m   2034\u001b[39m \u001b[43m    \u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m=\u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2035\u001b[39m \u001b[43m    \u001b[49m\u001b[43mengine\u001b[49m\u001b[43m=\u001b[49m\u001b[43mengine\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2036\u001b[39m \u001b[43m    \u001b[49m\u001b[43mencoding\u001b[49m\u001b[43m=\u001b[49m\u001b[43mencoding\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2037\u001b[39m \u001b[43m    \u001b[49m\u001b[43munlimited_dims\u001b[49m\u001b[43m=\u001b[49m\u001b[43munlimited_dims\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2038\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcompute\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcompute\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2039\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmultifile\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m   2040\u001b[39m \u001b[43m    \u001b[49m\u001b[43minvalid_netcdf\u001b[49m\u001b[43m=\u001b[49m\u001b[43minvalid_netcdf\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2041\u001b[39m \u001b[43m    \u001b[49m\u001b[43mauto_complex\u001b[49m\u001b[43m=\u001b[49m\u001b[43mauto_complex\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m   2042\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/api.py:1967\u001b[39m, in \u001b[36mto_netcdf\u001b[39m\u001b[34m(dataset, path_or_file, mode, format, group, engine, encoding, unlimited_dims, compute, multifile, invalid_netcdf, auto_complex)\u001b[39m\n\u001b[32m   1964\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m auto_complex \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m   1965\u001b[39m     kwargs[\u001b[33m\"\u001b[39m\u001b[33mauto_complex\u001b[39m\u001b[33m\"\u001b[39m] = auto_complex\n\u001b[32m-> \u001b[39m\u001b[32m1967\u001b[39m store = \u001b[43mstore_open\u001b[49m\u001b[43m(\u001b[49m\u001b[43mtarget\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mformat\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1969\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m unlimited_dims \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m   1970\u001b[39m     unlimited_dims = dataset.encoding.get(\u001b[33m\"\u001b[39m\u001b[33munlimited_dims\u001b[39m\u001b[33m\"\u001b[39m, \u001b[38;5;28;01mNone\u001b[39;00m)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:457\u001b[39m, in \u001b[36mNetCDF4DataStore.open\u001b[39m\u001b[34m(cls, filename, mode, format, group, clobber, diskless, persist, auto_complex, lock, lock_maker, autoclose)\u001b[39m\n\u001b[32m    453\u001b[39m     kwargs[\u001b[33m\"\u001b[39m\u001b[33mauto_complex\u001b[39m\u001b[33m\"\u001b[39m] = auto_complex\n\u001b[32m    454\u001b[39m manager = CachingFileManager(\n\u001b[32m    455\u001b[39m     netCDF4.Dataset, filename, mode=mode, kwargs=kwargs\n\u001b[32m    456\u001b[39m )\n\u001b[32m--> \u001b[39m\u001b[32m457\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mcls\u001b[39;49m\u001b[43m(\u001b[49m\u001b[43mmanager\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m=\u001b[49m\u001b[43mgroup\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mmode\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmode\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mlock\u001b[49m\u001b[43m=\u001b[49m\u001b[43mlock\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m=\u001b[49m\u001b[43mautoclose\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:398\u001b[39m, in \u001b[36mNetCDF4DataStore.__init__\u001b[39m\u001b[34m(self, manager, group, mode, lock, autoclose)\u001b[39m\n\u001b[32m    396\u001b[39m \u001b[38;5;28mself\u001b[39m._group = group\n\u001b[32m    397\u001b[39m \u001b[38;5;28mself\u001b[39m._mode = mode\n\u001b[32m--> \u001b[39m\u001b[32m398\u001b[39m \u001b[38;5;28mself\u001b[39m.format = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mds\u001b[49m.data_model\n\u001b[32m    399\u001b[39m \u001b[38;5;28mself\u001b[39m._filename = \u001b[38;5;28mself\u001b[39m.ds.filepath()\n\u001b[32m    400\u001b[39m \u001b[38;5;28mself\u001b[39m.is_remote = is_remote_uri(\u001b[38;5;28mself\u001b[39m._filename)\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:466\u001b[39m, in \u001b[36mNetCDF4DataStore.ds\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    464\u001b[39m \u001b[38;5;129m@property\u001b[39m\n\u001b[32m    465\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mds\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[32m--> \u001b[39m\u001b[32m466\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_acquire\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/netCDF4_.py:460\u001b[39m, in \u001b[36mNetCDF4DataStore._acquire\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    459\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m_acquire\u001b[39m(\u001b[38;5;28mself\u001b[39m, needs_lock=\u001b[38;5;28;01mTrue\u001b[39;00m):\n\u001b[32m--> \u001b[39m\u001b[32m460\u001b[39m \u001b[43m    \u001b[49m\u001b[38;5;28;43;01mwith\u001b[39;49;00m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_manager\u001b[49m\u001b[43m.\u001b[49m\u001b[43macquire_context\u001b[49m\u001b[43m(\u001b[49m\u001b[43mneeds_lock\u001b[49m\u001b[43m)\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43;01mas\u001b[39;49;00m\u001b[43m \u001b[49m\u001b[43mroot\u001b[49m\u001b[43m:\u001b[49m\n\u001b[32m    461\u001b[39m \u001b[43m        \u001b[49m\u001b[43mds\u001b[49m\u001b[43m \u001b[49m\u001b[43m=\u001b[49m\u001b[43m \u001b[49m\u001b[43m_nc4_require_group\u001b[49m\u001b[43m(\u001b[49m\u001b[43mroot\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_group\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_mode\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    462\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m ds\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/contextlib.py:141\u001b[39m, in \u001b[36m_GeneratorContextManager.__enter__\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    139\u001b[39m \u001b[38;5;28;01mdel\u001b[39;00m \u001b[38;5;28mself\u001b[39m.args, \u001b[38;5;28mself\u001b[39m.kwds, \u001b[38;5;28mself\u001b[39m.func\n\u001b[32m    140\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m141\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mnext\u001b[39;49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mgen\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    142\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mStopIteration\u001b[39;00m:\n\u001b[32m    143\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mRuntimeError\u001b[39;00m(\u001b[33m\"\u001b[39m\u001b[33mgenerator didn\u001b[39m\u001b[33m'\u001b[39m\u001b[33mt yield\u001b[39m\u001b[33m\"\u001b[39m) \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mNone\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/file_manager.py:199\u001b[39m, in \u001b[36mCachingFileManager.acquire_context\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    196\u001b[39m \u001b[38;5;129m@contextlib\u001b[39m.contextmanager\n\u001b[32m    197\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34macquire_context\u001b[39m(\u001b[38;5;28mself\u001b[39m, needs_lock=\u001b[38;5;28;01mTrue\u001b[39;00m):\n\u001b[32m    198\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"Context manager for acquiring a file.\"\"\"\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m199\u001b[39m     file, cached = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_acquire_with_cache_info\u001b[49m\u001b[43m(\u001b[49m\u001b[43mneeds_lock\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    200\u001b[39m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    201\u001b[39m         \u001b[38;5;28;01myield\u001b[39;00m file\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/xarray/backends/file_manager.py:217\u001b[39m, in \u001b[36mCachingFileManager._acquire_with_cache_info\u001b[39m\u001b[34m(self, needs_lock)\u001b[39m\n\u001b[32m    215\u001b[39m     kwargs = kwargs.copy()\n\u001b[32m    216\u001b[39m     kwargs[\u001b[33m\"\u001b[39m\u001b[33mmode\u001b[39m\u001b[33m\"\u001b[39m] = \u001b[38;5;28mself\u001b[39m._mode\n\u001b[32m--> \u001b[39m\u001b[32m217\u001b[39m file = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_opener\u001b[49m\u001b[43m(\u001b[49m\u001b[43m*\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_args\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    218\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m._mode == \u001b[33m\"\u001b[39m\u001b[33mw\u001b[39m\u001b[33m\"\u001b[39m:\n\u001b[32m    219\u001b[39m     \u001b[38;5;66;03m# ensure file doesn't get overridden when opened again\u001b[39;00m\n\u001b[32m    220\u001b[39m     \u001b[38;5;28mself\u001b[39m._mode = \u001b[33m\"\u001b[39m\u001b[33ma\u001b[39m\u001b[33m\"\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32msrc/netCDF4/_netCDF4.pyx:2521\u001b[39m, in \u001b[36mnetCDF4._netCDF4.Dataset.__init__\u001b[39m\u001b[34m()\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32msrc/netCDF4/_netCDF4.pyx:2158\u001b[39m, in \u001b[36mnetCDF4._netCDF4._ensure_nc_success\u001b[39m\u001b[34m()\u001b[39m\n\n\u001b[31mPermissionError\u001b[39m: [Errno 13] Permission denied: '/home/runner/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/climkern/data/kernels/ERA5/TOA_ERA5_Kerns.nc'","ename":"PermissionError","evalue":"[Errno 13] Permission denied: '/home/runner/micromamba/envs/feedback-cookbook-dev/lib/python3.13/site-packages/climkern/data/kernels/ERA5/TOA_ERA5_Kerns.nc'"}],"key":"qmNprZ27Fa"}],"key":"sXykdKr2CF"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prepare the CMIP6 Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"senTowJtQh"}],"identifier":"prepare-the-cmip6-data","label":"Prepare the CMIP6 Data","html_id":"prepare-the-cmip6-data","implicit":true,"key":"hLNyQ7xbhl"}],"key":"JGEkCgq7xM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"To start, we will need some CMIP6 data to calculate feedbacks. We will use the\npreindustrial control and 4×CO","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A0AdujO7B4"},{"type":"inlineMath","value":"_2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4511em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>","key":"I6ViRZdxja"},{"type":"text","value":" experiments from two models: CESM2 and GFDL CM4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E125FVPU0B"}],"key":"euEhzRjSaF"}],"key":"rxPLJTyBVK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Make a list of variables and experiments we need\nvar_list = [\"ta\",\"ts\",\"ps\",\"hus\"]\nexp_list = [\"piControl\",\"abrupt-4xCO2\"]\n\n# Specify data location, open it\ncat_url = \"https://storage.googleapis.com/cmip6/pangeo-cmip6.json\"\ncol = intake.open_esm_datastore(cat_url)","key":"zSyhC4yCcN"},{"type":"output","id":"yGlG703-al79snAgKUeKx","data":[],"key":"izSwjpvSEA"}],"key":"qecaSPkeNt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cat = col.search(experiment_id=exp_list,source_id=[\"CESM2\",\"GFDL-CM4\"],variable_id=var_list,\n                table_id=\"Amon\")","key":"zQPaCbTN8Y"},{"type":"output","id":"sLOrdHy03TGpawkxsqXqY","data":[],"key":"tXsi5Ms3Fu"}],"key":"ftV1mu7ea4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Convert to a dictionary of Xarray Datasets\nds_dict = cat.to_dataset_dict(xarray_open_kwargs={\"consolidated\": True, \"decode_times\": True, \"use_cftime\": True})","key":"NCjvO5ZS7T"},{"type":"output","id":"pdv3C_FZpVOzaH1i1XHbs","data":[],"key":"lw4CtRpmwk"}],"key":"yd7QrClcBq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The data, especially the preindustrial control simulation that will serve as our\ncontrol climate, is huge. We are going to only use the last 50 years of the control\nand last 30 years of the abrupt 4×CO","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dZ4Z1Z4NKF"},{"type":"inlineMath","value":"_2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4511em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>","key":"nMArJJ7k4e"},{"type":"text","value":" simulation. There are a few extra coordinates\nand/or dimensions we don’t need, hence the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BgpANCFjQ0"},{"type":"inlineCode","value":"squeeze()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AV92Kdw8Jo"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HD92ii4Ojk"}],"key":"iYzi4kPTPg"}],"key":"mHXJ3iqN46"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Our control simulation\nctrl_cesm2 = ds_dict[\"CMIP.NCAR.CESM2.piControl.Amon.gn\"].isel(\n    time=slice(-600,None)).compute()\n\n# The increase CO2 aka \"perturbed\" simulation\npert_cesm2 = ds_dict[\"CMIP.NCAR.CESM2.abrupt-4xCO2.Amon.gn\"].isel(\n    time=slice(-360,None)).compute()","key":"P3n6cgOh1i"},{"type":"output","id":"hnlkITJMNj-YLnhE1OTrS","data":[],"key":"aRinUycqnC"}],"key":"JKMjQAnzz5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ctrl_cm4 = ds_dict[\"CMIP.NOAA-GFDL.GFDL-CM4.piControl.Amon.gr1\"].isel(time=slice(-50*12,None)).compute()\npert_cm4 = ds_dict[\"CMIP.NOAA-GFDL.GFDL-CM4.abrupt-4xCO2.Amon.gr1\"].isel(time=slice(-30*12,None)).compute()","key":"VCjKsP47Ep"},{"type":"output","id":"1b0pib-wrvRXemp7vne-Q","data":[],"key":"Bk7SISMETu"}],"key":"EOlFMTdXYt"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def make_monthly_clim(dataset):\n    return dataset.groupby(dataset.time.dt.month).mean(dim=\"time\").rename({\"month\":\"time\"})","key":"nvpTBiQMFe"},{"type":"output","id":"Vd-oKLzI07NuXzd9XzKQg","data":[],"key":"mIUskMgGzQ"}],"key":"ay5hWRv0Sz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ctrl_cesm2 = make_monthly_clim(ctrl_cesm2)\npert_cesm2 = make_monthly_clim(pert_cesm2)\nctrl_cm4 = make_monthly_clim(ctrl_cm4)\npert_cm4 = make_monthly_clim(pert_cm4)","key":"kItIQGpMzk"},{"type":"output","id":"l77KsUUcF2z09pmAtA_tI","data":[],"key":"YPBX24agig"}],"key":"vcVnXHBRWV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Feedback calculations","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FhE4dez8ZT"}],"identifier":"feedback-calculations","label":"Feedback calculations","html_id":"feedback-calculations","implicit":true,"key":"gaR5pEt3eq"}],"key":"CmjWEu4rj9"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calculate surface temperature change","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Kv2tsPHw3a"}],"identifier":"calculate-surface-temperature-change","label":"Calculate surface temperature change","html_id":"calculate-surface-temperature-change","implicit":true,"key":"hUvm99B0lo"}],"key":"eAww2gsJrk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Take difference between pert and ctrl ts fields\nΔts_cesm2 = pert_cesm2.ts - ctrl_cesm2.ts\nΔts_cm4 = pert_cm4.ts - ctrl_cm4.ts","key":"UNjEROA7so"},{"type":"output","id":"pTVRFhxwCU1BAwAjsE1Yx","data":[],"key":"bD623jUhEB"}],"key":"NyBfZMZZOm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Planck and lapse rate feedbacks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fkLWpsv2SS"}],"identifier":"planck-and-lapse-rate-feedbacks","label":"Planck and lapse rate feedbacks","html_id":"planck-and-lapse-rate-feedbacks","implicit":true,"key":"EZ43elD0AT"}],"key":"CDu8txD9ZZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Use ClimKern's \"hidden\" make_tropo function\npert_cesm2[\"trop_p\"] = ck.util.make_tropo(pert_cesm2.ps)\npert_cesm2.trop_p.attrs[\"units\"] = \"Pa\"\n\nlr_cesm2,pl_cesm2 = ck.calc_T_feedbacks(\n    ctrl_cesm2.ta,ctrl_cesm2.ts,ctrl_cesm2.ps,\n    pert_cesm2.ta,pert_cesm2.ts,pert_cesm2.ps,\n    pert_trop=pert_cesm2.trop_p,\n    kern=\"ERA5\"\n)","key":"A0nYEJ9zjS"},{"type":"output","id":"UIrww1FiaPiHCMWh7LjLt","data":[],"key":"EWo4OpL3Ek"}],"key":"Gq36EOtkOg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"pert_cm4[\"trop_p\"] = ck.util.make_tropo(pert_cm4.ps)\npert_cm4.trop_p.attrs[\"units\"] = \"Pa\"\n\nlr_cm4,pl_cm4 = ck.calc_T_feedbacks(\n    ctrl_cm4.ta, ctrl_cm4.ts, ctrl_cm4.ps,\n    pert_cm4.ta, pert_cm4.ts, pert_cm4.ps,\n    pert_trop=pert_cm4.trop_p,\n    kern=\"ERA5\"\n)","key":"qMuQkSMNlk"},{"type":"output","id":"OnuC3L7u5ACUU51lZtsYF","data":[],"key":"YyDEOClLA6"}],"key":"gXXhFBdjfJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lr_cesm2_norm_mean = (lr_cesm2.mean(dim='time') / Δts_cesm2.mean(dim=\"time\")).squeeze()\nlr_cm4_norm_mean = (lr_cm4.mean(dim='time') / Δts_cm4.mean(dim=\"time\")).squeeze()","key":"zZIAJ4Qtfk"},{"type":"output","id":"ftieO1aCnHfgxtvVkiThu","data":[],"key":"iG6JZ3cOVY"}],"key":"GizwtwCKhl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"proj = ccrs.Robinson()\n\nfig, axes = plt.subplots(1,2, figsize=(10,4), subplot_kw=dict(projection=proj),\n                       layout=\"constrained\")\n\nplotargs = {\"vmin\": -7,\n            \"vmax\": 7,\n            \"cmap\": \"RdBu_r\",\n            \"cbar_kwargs\": {\"orientation\": \"horizontal\", \"shrink\": 0.7,\n                                      \"label\":\"W/m$^2$/K\"}\n           }\n\nax = axes[0]\n(lr_cesm2_norm_mean).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('CESM2')\n\nax = axes[1]\n(lr_cm4_norm_mean).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('GFDL CM4')\n\nfor ax in axes:\n    ax.coastlines()\n    \nfig.suptitle('Lapse Rate Feedback (multi-model comparison)');","key":"LdPVWET34U"},{"type":"output","id":"WBO7qMu0sz1wbjXKR_FIb","data":[],"key":"k9aayWpG2D"}],"key":"yoHwQBAWj7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Water vapor feedbacks","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"poBWG9R6G8"}],"identifier":"water-vapor-feedbacks","label":"Water vapor feedbacks","html_id":"water-vapor-feedbacks","implicit":true,"key":"vpqmllhFlu"}],"key":"xvRcFDmxr0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Use ClimKern's water vapor feedback function\nqlw_cesm2, qsw_cesm2 = ck.calc_q_feedbacks(\n    ctrl_cesm2.hus, ctrl_cesm2.ta, ctrl_cesm2.ps,\n    pert_cesm2.hus, pert_cesm2.ps, pert_trop=pert_cesm2.trop_p,\n    kern=\"ERA5\",\n    method=1\n)","key":"jQvXcah89T"},{"type":"output","id":"U3vlhCaX4KAWSWRYNWCla","data":[],"key":"HyWOv6fnNd"}],"key":"cDnqzmB3ik"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"qlw_cm4, qsw_cm4 = ck.calc_q_feedbacks(\n    ctrl_cm4.hus, ctrl_cm4.ta, ctrl_cm4.ps,\n    pert_cm4.hus, pert_cm4.ps, pert_trop=pert_cm4.trop_p,\n    kern=\"ERA5\",\n    method=1\n)","key":"URtBuTpCVh"},{"type":"output","id":"CyF9Ny5KvxbeIi2sfC9Uw","data":[],"key":"UFBx6FnYlP"}],"key":"PNqNQu6n88"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"qlw_cesm2_norm_mean = (qlw_cesm2.mean(dim='time') / Δts_cesm2.mean(dim=\"time\")).squeeze()\nqlw_cm4_norm_mean = (qlw_cm4.mean(dim='time') / Δts_cm4.mean(dim=\"time\")).squeeze()\n\nqsw_cesm2_norm_mean = (qsw_cesm2.mean(dim='time') / Δts_cesm2.mean(dim=\"time\")).squeeze()\nqsw_cm4_norm_mean = (qsw_cm4.mean(dim='time') / Δts_cm4.mean(dim=\"time\")).squeeze()\n\nqtotal_cesm2_norm_mean = qlw_cesm2_norm_mean + qsw_cesm2_norm_mean\nqtotal_cm4_norm_mean = qlw_cm4_norm_mean + qsw_cm4_norm_mean","key":"mrDeDSYKzF"},{"type":"output","id":"2hzP3TpsSpBo5BbyKXfpj","data":[],"key":"L5qBqs4ifH"}],"key":"qeQYf3vhIl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s take a look!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qQc0eaRolv"}],"key":"IMP8v7PhLm"}],"key":"lNmIJ4D69k"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, axes = plt.subplots(1,2, figsize=(10,4), subplot_kw=dict(projection=proj),\n                       layout=\"constrained\")\n\nplotargs = {\"vmin\": 0,\n            \"vmax\": 10,\n            \"cmap\": \"Reds\",\n            \"cbar_kwargs\": {\"orientation\": \"horizontal\", \"shrink\": 0.7,\n                                      \"label\":\"W/m$^2$/K\"}\n           }\n\nax = axes[0]\n(qtotal_cesm2_norm_mean).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('CESM2')\n\nax = axes[1]\n(qtotal_cm4_norm_mean).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('GFDL CM4')\n\nfor ax in axes:\n    ax.coastlines()\n    \nfig.suptitle('Water Vapor Feedback (multi-model comparison)');","key":"u8yZ9Xzl0l"},{"type":"output","id":"3BUFRMw0IFCU1_2QdClpn","data":[],"key":"ZHL5vO8kc1"}],"key":"ob6T84JmDm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can see that GFDL CM4 tends to have larger magnitudes of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LJE6dZk5Pm"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"both","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qLBqAlzbzs"}],"key":"GAANKbf6gk"},{"type":"text","value":" the lapse rate and water vapor feedbacks compared to CESM2.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v3oG1nRUt8"}],"key":"k8tPRtCtGa"}],"key":"Oh952IUA8G"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combined water vapor plus lapse rate feedback","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bk5B2fTLgZ"}],"identifier":"combined-water-vapor-plus-lapse-rate-feedback","label":"Combined water vapor plus lapse rate feedback","html_id":"combined-water-vapor-plus-lapse-rate-feedback","implicit":true,"key":"KGJwUic9em"}],"key":"IUwZsNt972"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"combo_cesm2 = qtotal_cesm2_norm_mean + lr_cesm2_norm_mean\ncombo_cm4 = qtotal_cm4_norm_mean + lr_cm4_norm_mean","key":"o6dmaNPIi6"},{"type":"output","id":"ksgtbDhKsRVOPnDua9t6V","data":[],"key":"PRWeaLeWiH"}],"key":"laLDOyCnyr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, axes = plt.subplots(1,2, figsize=(10,4), subplot_kw=dict(projection=proj),\n                       layout=\"constrained\")\n\nplotargs = {\"vmin\": -7,\n            \"vmax\": 7,\n            \"cmap\": \"RdBu_r\",\n            \"cbar_kwargs\": {\"orientation\": \"horizontal\", \"shrink\": 0.7,\n                                      \"label\":\"W/m$^2$/K\"}\n           }\n\nax = axes[0]\n(combo_cesm2).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('CESM2')\n\nax = axes[1]\n(combo_cm4).plot(ax=ax,transform=ccrs.PlateCarree(), **plotargs)\nax.set_title('GFDL CM4')\n\nfor ax in axes:\n    ax.coastlines()\n    \nfig.suptitle('Combined water vapor plus lapse rate feedback (multi-model comparison)');","key":"EtIhD5D3Cv"},{"type":"output","id":"kBOjGXoMFxWsIlAmZGtQu","data":[],"key":"lIqfjtowq4"}],"key":"ZtBBIDUeDB"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Looks like the differences between the two models are more modest when we combine the two feedbacks!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lqLMc8stAq"}],"key":"KeHN9zdHyH"}],"key":"fISQeGUnZu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Tabulate the global mean results","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OaNAWpjVHx"}],"identifier":"tabulate-the-global-mean-results","label":"Tabulate the global mean results","html_id":"tabulate-the-global-mean-results","implicit":true,"key":"NkfwqTYSMN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"We’ll display the global mean values in units of W m","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zdtMpZ6glx"},{"type":"inlineMath","value":"^{-^2}","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><msup><mo>−</mo><mn>2</mn></msup></msup></mrow><annotation encoding=\"application/x-tex\">^{-^2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9869em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9869em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mbin mtight\">−</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8913em;\"><span style=\"top:-2.931em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>","key":"RHavBMoHIr"},{"type":"text","value":" K","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kIkLo7asAr"},{"type":"inlineMath","value":"^{-1}","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mrow></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding=\"application/x-tex\">^{-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span></span>","key":"q5fdYnU3aB"},{"type":"text","value":":","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dnLKzyCkbj"}],"key":"qXq5quk9mS"}],"key":"ZRvbGix90C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def global_mean(data):\n    weights = np.cos(np.deg2rad(data.lat))\n    return data.weighted(weights=weights).mean(dim=['lat','lon']).compute()","key":"pn6POT08v2"},{"type":"output","id":"KQh8pN9u_iQLgLAhehMwq","data":[],"key":"CWsS6CjjYf"}],"key":"uMrhuZ86ZR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"results = pd.DataFrame([\n              [float(global_mean(qtotal_cesm2_norm_mean)), float(global_mean(lr_cesm2_norm_mean)), float(global_mean(combo_cesm2))],  \n              [float(global_mean(qtotal_cm4_norm_mean)), float(global_mean(lr_cm4_norm_mean)), float(global_mean(combo_cm4))],\n             ], \n            columns=[\"Water vapor \", \"Lapse rate\", \"Combined WV+LR\"],\n                       index=[\"CESM2\", \"GFDL CM4\"],\n                      )\nresults","key":"PZx6bvH2Wo"},{"type":"output","id":"DldUOUJfVqYTD8N7dQjjg","data":[],"key":"rbsYFzU8Mb"}],"key":"BH0CmfdhdN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So, in conclusion, yes the difference in the combined feedbacks is smaller than the differences in the individual feedbacks!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c0tZdjYBap"}],"key":"xqpOAwpjXS"}],"key":"zkK1ht9Lin"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To do","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dpW4oRV3EH"}],"identifier":"to-do","label":"To do","html_id":"to-do","implicit":true,"key":"pt8VoK9jS1"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Some interesting additions to this notebook:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uIjObzrCzn"}],"key":"nPQFmTA5jm"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Refactor the code to loop through models rather than copy and paste the repeated operations","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fLYEk8Uqll"}],"key":"bU7TRBb6bN"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Bring some more models into the comparison","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"pdQ1rDKOV9"}],"key":"LJcpYVOIaQ"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Express feedbacks in the alternate relative humidity framework discussed by ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"dl9y0OaN5h"},{"type":"citeGroup","kind":"narrative","children":[{"type":"cite","kind":"narrative","label":"Held:2012a","identifier":"held:2012a","children":[{"type":"text","value":"Held & Shell (2012)","key":"n3sMbVjt9D"}],"enumerator":"1","key":"jmJ76udyZR"}],"key":"Ed3C8hLIP1"}],"key":"Ua6cyLuCC8"}],"key":"NAWiFmyxuA"}],"key":"zBMV0tr4Mf"}],"key":"oy5dRU8fpx"},"references":{"cite":{"order":["Held:2012a"],"data":{"Held:2012a":{"label":"Held:2012a","enumerator":"1","doi":"10.1175/JCLI-D-11-00721.1","html":"Held, I. M., & Shell, K. M. (2012). Using Relative Humidity as a State Variable in Climate Feedback Analysis. <i>Journal of Climate</i>, <i>25</i>(8), 2578–2582. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1175/JCLI-D-11-00721.1\">10.1175/JCLI-D-11-00721.1</a>","url":"https://doi.org/10.1175/JCLI-D-11-00721.1"}}}},"footer":{"navigation":{"prev":{"title":"Feedbacks with ClimKern","url":"/notebooks/foundations/climkern-calc","group":"Foundations"}}},"domain":"http://localhost:3000"}